#!/usr/bin/env python3
"""
Скрипт для инициализации базы данных.
Запустите: python init_database.py
"""

import sys
import os

# Добавляем путь к проекту
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from app import create_app, db
from app.models import User, Category, Product, Review, Region, City

app = create_app()

def init_database():
    """Инициализация базы данных"""
    with app.app_context():
        print("Создание таблиц в базе данных...")
        
        # Создаем все таблицы
        db.create_all()
        
        print("✅ Таблицы созданы:")
        print("   - user")
        print("   - category") 
        print("   - product")
        print("   - review")
        print("   - region")
        print("   - city")
        
        # Проверяем, есть ли уже регионы
        regions_count = Region.query.count()
        if regions_count == 0:
            print("\nДобавление тестовых регионов и городов...")
            add_test_data()
        else:
            print(f"\nВ базе уже есть {regions_count} регионов")
        
        print("\n✅ База данных инициализирована!")

def add_test_data():
    """Добавление тестовых данных"""
    # Создаем основные регионы РФ
    regions_data = [
        ('Москва', 'Город федерального значения'),
        ('Санкт-Петербург', 'Город федерального значения'),
        ('Республика Татарстан', 'Республика в составе РФ'),
        ('Московская область', 'Область'),
        ('Свердловская область', 'Область'),
        ('Краснодарский край', 'Край'),
        ('Республика Башкортостан', 'Республика в составе РФ'),
        ('Нижегородская область', 'Область'),
        ('Челябинская область', 'Область'),
        ('Новосибирская область', 'Область'),
        ('Самарская область', 'Область'),
        ('Ростовская область', 'Область'),
        ('Красноярский край', 'Край'),
        ('Пермский край', 'Край'),
        ('Воронежская область', 'Область'),
        ('Ленинградская область', 'Область'),
        ('Республика Дагестан', 'Республика в составе РФ'),
        ('Ставропольский край', 'Край'),
        ('Саратовская область', 'Область'),
        ('Волгоградская область', 'Область'),
        ('Иркутская область', 'Область'),
        ('Омская область', 'Область'),
        ('Оренбургская область', 'Область'),
        ('Тюменская область', 'Область'),
        ('Ульяновская область', 'Область'),
        ('Хабаровский край', 'Край'),
        ('Ярославская область', 'Область'),
        ('Томская область', 'Область'),
        ('Кемеровская область', 'Область'),
        ('Алтайский край', 'Край'),
        ('Республика Крым', 'Республика в составе РФ'),
        ('Белгородская область', 'Область'),
        ('Пензенская область', 'Область'),
        ('Кировская область', 'Область'),
        ('Чеченская Республика', 'Республика в составе РФ'),
        ('Тульская область', 'Область'),
        ('Курская область', 'Область'),
        ('Астраханская область', 'Область'),
        ('Магаданская область', 'Область'),
        ('Тверская область', 'Область'),
        ('Липецкая область', 'Область'),
        ('Рязанская область', 'Область'),
        ('Брянская область', 'Область'),
        ('Новгородская область', 'Область'),
        ('Калужская область', 'Область'),
        ('Смоленская область', 'Область'),
        ('Сахалинская область', 'Область'),
        ('Орловская область', 'Область'),
        ('Владимирская область', 'Область'),
        ('Мурманская область', 'Область'),
        ('Костромская область', 'Область'),
        ('Республика Карелия', 'Республика в составе РФ'),
        ('Республика Коми', 'Республика в составе РФ'),
        ('Республика Саха (Якутия)', 'Республика в составе РФ'),
        ('Камчатский край', 'Край'),
        ('Приморский край', 'Край'),
        ('Забайкальский край', 'Край'),
        ('Республика Бурятия', 'Республика в составе РФ'),
        ('Республика Хакасия', 'Республика в составе РФ'),
        ('Амурская область', 'Область'),
        ('Еврейская автономная область', 'Автономная область'),
        ('Чукотский автономный округ', 'Автономный округ'),
        ('Ненецкий автономный округ', 'Автономный округ'),
        ('Ханты-Мансийский автономный округ — Югра', 'Автономный округ'),
        ('Ямало-Ненецкий автономный округ', 'Автономный округ')
    ]
    
    # Создаем регионы
    regions_dict = {}
    for name, description in regions_data:
        region = Region(name=name, description=description)
        db.session.add(region)
        db.session.flush()  # Получаем ID
        regions_dict[name] = region
    
    # Создаем города для основных регионов
    cities_data = [
        # Москва
        ('Москва', 'Москва'),
        
        # Санкт-Петербург
        ('Санкт-Петербург', 'Санкт-Петербург'),
        
        # Республика Татарстан
        ('Казань', 'Республика Татарстан'),
        ('Набережные Челны', 'Республика Татарстан'),
        ('Альметьевск', 'Республика Татарстан'),
        ('Нижнекамск', 'Республика Татарстан'),
        ('Зеленодольск', 'Республика Татарстан'),
        
        # Московская область
        ('Балашиха', 'Московская область'),
        ('Химки', 'Московская область'),
        ('Подольск', 'Московская область'),
        ('Королёв', 'Московская область'),
        ('Мытищи', 'Московская область'),
        ('Люберцы', 'Московская область'),
        ('Коломна', 'Московская область'),
        ('Электросталь', 'Московская область'),
        ('Одинцово', 'Московская область'),
        ('Жуковский', 'Московская область'),
        
        # Свердловская область
        ('Екатеринбург', 'Свердловская область'),
        ('Нижний Тагил', 'Свердловская область'),
        ('Каменск-Уральский', 'Свердловская область'),
        ('Первоуральск', 'Свердловская область'),
        ('Серов', 'Свердловская область'),
        
        # Краснодарский край
        ('Краснодар', 'Краснодарский край'),
        ('Сочи', 'Краснодарский край'),
        ('Новороссийск', 'Краснодарский край'),
        ('Армавир', 'Краснодарский край'),
        ('Ейск', 'Краснодарский край'),
        ('Геленджик', 'Краснодарский край'),
        
        # Республика Башкортостан
        ('Уфа', 'Республика Башкортостан'),
        ('Стерлитамак', 'Республика Башкортостан'),
        ('Салават', 'Республика Башкортостан'),
        ('Нефтекамск', 'Республика Башкортостан'),
        ('Октябрьский', 'Республика Башкортостан'),
        
        # Нижегородская область
        ('Нижний Новгород', 'Нижегородская область'),
        ('Дзержинск', 'Нижегородская область'),
        ('Арзамас', 'Нижегородская область'),
        ('Саров', 'Нижегородская область'),
        ('Кстово', 'Нижегородская область'),
        
        # Челябинская область
        ('Челябинск', 'Челябинская область'),
        ('Магнитогорск', 'Челябинская область'),
        ('Златоуст', 'Челябинская область'),
        ('Миасс', 'Челябинская область'),
        ('Копейск', 'Челябинская область'),
        
        # Новосибирская область
        ('Новосибирск', 'Новосибирская область'),
        ('Бердск', 'Новосибирская область'),
        ('Искитим', 'Новосибирская область'),
        ('Куйбышев', 'Новосибирская область'),
        
        # Самарская область
        ('Самара', 'Самарская область'),
        ('Тольятти', 'Самарская область'),
        ('Сызрань', 'Самарская область'),
        ('Новокуйбышевск', 'Самарская область'),
        ('Чапаевск', 'Самарская область'),
        
        # Ростовская область
        ('Ростов-на-Дону', 'Ростовская область'),
        ('Таганрог', 'Ростовская область'),
        ('Шахты', 'Ростовская область'),
        ('Волгодонск', 'Ростовская область'),
        ('Новочеркасск', 'Ростовская область'),
        
        # Красноярский край
        ('Красноярск', 'Красноярский край'),
        ('Норильск', 'Красноярский край'),
        ('Ачинск', 'Красноярский край'),
        ('Канск', 'Красноярский край'),
        ('Железногорск', 'Красноярский край'),
        
        # Пермский край
        ('Пермь', 'Пермский край'),
        ('Березники', 'Пермский край'),
        ('Соликамск', 'Пермский край'),
        ('Чайковский', 'Пермский край'),
        ('Кунгур', 'Пермский край'),
        
        # Воронежская область
        ('Воронеж', 'Воронежская область'),
        ('Борисоглебск', 'Воронежская область'),
        ('Россошь', 'Воронежская область'),
        ('Лиски', 'Воронежская область'),
        ('Павловск', 'Воронежская область'),
        
        # Ленинградская область
        ('Гатчина', 'Ленинградская область'),
        ('Выборг', 'Ленинградская область'),
        ('Тосно', 'Ленинградская область'),
        ('Кириши', 'Ленинградская область'),
        ('Волхов', 'Ленинградская область'),
        
        # Республика Дагестан
        ('Махачкала', 'Республика Дагестан'),
        ('Хасавюрт', 'Республика Дагестан'),
        ('Дербент', 'Республика Дагестан'),
        ('Каспийск', 'Республика Дагестан'),
        ('Буйнакск', 'Республика Дагестан'),
    ]
    
    # Создаем города
    cities_count = 0
    for city_name, region_name in cities_data:
        region = regions_dict.get(region_name)
        if region:
            city = City(name=city_name, region_id=region.id)
            db.session.add(city)
            cities_count += 1
    
    db.session.commit()
    
    print(f"   Добавлено {len(regions_dict)} регионов")
    print(f"   Добавлено {cities_count} городов")

if __name__ == '__main__':
    try:
        init_database()
    except Exception as e:
        print(f"❌ Ошибка: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)