{% extends "base.html" %}

{% block content %}
<style>
    /* CSS сортировка */
    .sort-icon::before {
        content: '\f0dc';
        /* fa-sort */
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
        color: #ccc;
    }

    th.sort-asc .sort-icon::before {
        content: '\f0de';
        /* fa-sort-up */
        color: #007bff;
    }

    th.sort-desc .sort-icon::before {
        content: '\f0dd';
        /* fa-sort-down */
        color: #007bff;
    }

    .empty-icon {
        font-size: 48px;
        color: #ccc;
    }
</style>
<div class="dashboard-container">
    <div class="dashboard-layout">
        <!-- Левое меню -->
        <aside class="dashboard-sidebar">
            <nav class="sidebar-nav">
                <ul class="nav-menu">
                    <li class="nav-item active">
                        <a href="{{ url_for('main.dashboard') }}" class="nav-link">
                            <span class="nav-text">Мои объявления</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link">
                            <span class="nav-text">Мои отзывы</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="{{ url_for('main.favorites') }}" class="nav-link">
                            <span class="nav-text">Избранное</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link">
                            <span class="nav-text">Сообщения</span>
                            <span class="badge">3</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link">
                            <span class="nav-text">Уведомления</span>
                            <span class="badge">5</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link">
                            <span class="nav-text">Рассылки</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="{{ url_for('main.profile') }}" class="nav-link">
                            <span class="nav-text">Управление профилем</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link">
                            <span class="nav-text">Настройки</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Основной контент -->
        <main class="dashboard-main">
            <div class="dashboard-header">
                <div class="header-top-row">
                    <h1>
                        {% if current_user.company_name %}
                        {{ current_user.company_name }}
                        {% else %}
                        Название организации не указано
                        {% endif %}
                        -
                        {% if current_user.contact_person %}
                        {{ current_user.contact_person }}
                        {% elif current_user.username %}
                        {{ current_user.username }}
                        {% else %}
                        {{ current_user.email }}
                        {% endif %}
                    </h1>
                </div>
                <div class="dashboard-controls">
                    <div class="view-toggle">
                        <button class="view-btn active" data-view="grid" title="Плитка">
                            <i class="fas fa-th-large"></i>
                        </button>
                        <button class="view-btn" data-view="list" title="Список">
                            <i class="fas fa-list"></i>
                        </button>
                        <button class="view-btn" data-view="table" title="Таблица">
                            <i class="fas fa-table"></i>
                        </button>
                    </div>
                    <a href="{{ url_for('main.add_product') }}" class="btn-add-product">
                        <i class="fas fa-plus"></i> Добавить товар
                    </a>
                </div>
            </div>

            {% if products %}
            <!-- Вид плиткой (по умолчанию) -->
            <div class="products-grid" id="productsGrid">
                {% for product in products %}
                <div class="product-card {% if product.status != product.STATUS_PUBLISHED %}product-unpublished{% endif %}"
                    onclick="window.location.href='{{ url_for('main.product_detail', product_id=product.id) }}'"
                    style="cursor: pointer;">
                    <div class="product-image">
                        {% if product.image_list and product.image_list|length > 0 %}
                        <img src="{{ url_for('main.serve_uploaded_file', filename=product.image_list[0]) }}"
                            alt="{{ product.title }}">
                        {% else %}
                        <div class="no-image"><i class="fas fa-camera"></i></div>
                        {% endif %}

                        <!-- Бейдж статуса -->
                        <div class="product-status-badge status-{{ product.status }}">
                            {{ product.status_text }}
                            {% if product.status == product.STATUS_PUBLISHED and product.days_remaining > 0 %}
                            <span class="days-remaining">({{ product.days_remaining }} дн.)</span>
                            {% elif product.status == product.STATUS_PUBLISHED and product.days_remaining == 0 %}
                            <span class="days-remaining">(сегодня)</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="product-info">
                        <h3 class="product-title">{{ product.title }}</h3>
                        <p class="product-price">
                            {{ product.price|format_price }} ₽
                            {% if product.vat_included %}
                            <span class="vat-label vat-included">С НДС</span>
                            {% else %}
                            <span class="vat-label vat-excluded">Без НДС</span>
                            {% endif %}
                        </p>
                        <div class="product-views">
                            <span class="views-count">
                                <img src="{{ url_for('static', filename='icons/eye_icon.svg') }}" alt=""
                                    style="width: 14px; height: 14px; vertical-align: middle; opacity: 0.6; margin-right: 4px;">
                                {{ product.view_count if product.view_count else 0 }}
                            </span>
                        </div>
                        <p class="product-description">{{ product.description|truncate(100) if product.description else
                            'Нет описания' }}</p>

                        <div class="product-meta">
                            <span class="category">{{ product.product_category.name if product.product_category else
                                'Без категории' }}</span>
                            <span class="date">{{ product.created_at.strftime('%d.%m.%Y') }}</span>
                        </div>
                    </div>

                    <div class="product-actions" onclick="event.stopPropagation();">
                        <a href="{{ url_for('main.product_detail', product_id=product.id) }}" class="btn-view">
                            Посмотреть
                        </a>

                        {% if product.status == product.STATUS_PUBLISHED %}
                        <form action="{{ url_for('main.unpublish_product', product_id=product.id) }}" method="POST"
                            class="action-form">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                            <button type="submit" class="btn-unpublish"
                                onclick="event.stopPropagation(); return confirm('Снять товар с публикации? Он станет виден только вам.')">
                                Снять
                            </button>
                        </form>
                        {% elif product.status == product.STATUS_READY_FOR_PUBLICATION or product.status ==
                        product.STATUS_UNPUBLISHED %}
                        <form action="{{ url_for('main.renew_product', product_id=product.id) }}" method="POST"
                            class="action-form">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                            <button type="submit" class="btn-publish" onclick="event.stopPropagation();">
                                Опубликовать
                            </button>
                        </form>
                        {% endif %}

                        <form action="{{ url_for('main.delete_product', product_id=product.id) }}" method="POST"
                            class="action-form"
                            onsubmit="event.stopPropagation(); return confirm('Удалить товар? Это действие нельзя отменить.')">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                            <button type="submit" class="btn-delete" onclick="event.stopPropagation();">
                                Удалить
                            </button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Вид списком -->
            <div class="products-list" id="productsList" style="display: none;">
                {% for product in products %}
                <div class="list-product-card {% if product.status != product.STATUS_PUBLISHED %}product-unpublished{% endif %}"
                    onclick="window.location.href='{{ url_for('main.product_detail', product_id=product.id) }}'"
                    style="cursor: pointer;">
                    <div class="list-product-image">
                        {% if product.image_list and product.image_list|length > 0 %}
                        <img src="{{ url_for('main.serve_uploaded_file', filename=product.image_list[0]) }}"
                            alt="{{ product.title }}">
                        {% else %}
                        <div class="no-image-small"><i class="fas fa-camera"></i></div>
                        {% endif %}
                    </div>

                    <div class="list-product-info">
                        <h3 class="list-product-title">{{ product.title }}</h3>
                        <p class="list-product-description">{{ product.description|truncate(150) if product.description
                            else 'Нет описания' }}</p>

                        <div class="list-product-meta">
                            <span class="list-category">{{ product.product_category.name if product.product_category
                                else 'Без категории' }}</span>
                            <span class="list-date">{{ product.created_at.strftime('%d.%m.%Y') }}</span>
                            <span class="list-status status-{{ product.status }}">{{ product.status_text }}</span>
                        </div>
                    </div>

                    <div class="list-product-price">
                        <span class="price-value">{{ "%.2f"|format(product.price) }} ₽</span>
                        {% if product.vat_included %}
                        <span class="vat-label vat-included">С НДС</span>
                        {% else %}
                        <span class="vat-label vat-excluded">Без НДС</span>
                        {% endif %}
                    </div>

                    <div class="list-product-actions" onclick="event.stopPropagation();">
                        {% if product.status == product.STATUS_PUBLISHED %}
                        <form action="{{ url_for('main.unpublish_product', product_id=product.id) }}" method="POST"
                            class="action-form">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                            <button type="submit" class="btn-unpublish"
                                onclick="event.stopPropagation(); return confirm('Снять товар с публикации? Он станет виден только вам.')">
                                Снять
                            </button>
                        </form>
                        {% elif product.status == product.STATUS_READY_FOR_PUBLICATION or product.status ==
                        product.STATUS_UNPUBLISHED %}
                        <form action="{{ url_for('main.renew_product', product_id=product.id) }}" method="POST"
                            class="action-form">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                            <button type="submit" class="btn-publish" onclick="event.stopPropagation();">
                                Опубликовать
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Вид таблицей -->
            <div class="products-table-container" id="productsTable" style="display: none;">
                <div class="table-wrapper">
                    <table class="products-data-table">
                        <thead>
                            <tr>
                                <th data-sort="title" class="sortable">
                                    <div class="table-header-content">
                                        <div class="header-text">Название товара</div>
                                        <div class="sort-icon"></div>
                                    </div>
                                </th>
                                <th data-sort="price" class="sortable">
                                    <div class="table-header-content">
                                        <div class="header-text">Цена</div>
                                        <div class="sort-icon"></div>
                                    </div>
                                </th>
                                <th data-sort="vat_included" class="sortable">
                                    <div class="table-header-content">
                                        <div class="header-text">НДС</div>
                                        <div class="sort-icon"></div>
                                    </div>
                                </th>
                                <th data-sort="condition" class="sortable">
                                    <div class="table-header-content">
                                        <div class="header-text">Состояние</div>
                                        <div class="sort-icon"></div>
                                    </div>
                                </th>
                                <th data-sort="region" class="sortable">
                                    <div class="table-header-content">
                                        <div class="header-text">Регион</div>
                                        <div class="sort-icon"></div>
                                    </div>
                                </th>
                                <th data-sort="city" class="sortable">
                                    <div class="table-header-content">
                                        <div class="header-text">Город</div>
                                        <div class="sort-icon"></div>
                                    </div>
                                </th>
                                <th data-sort="delivery" class="sortable">
                                    <div class="table-header-content">
                                        <div class="header-text">Доставка</div>
                                        <div class="sort-icon"></div>
                                    </div>
                                </th>
                                <th data-sort="status" class="sortable">
                                    <div class="table-header-content">
                                        <div class="header-text">Статус</div>
                                        <div class="sort-icon"></div>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in products[:20] %}
                            <tr class="table-product-row {% if product.status != product.STATUS_PUBLISHED %}product-unpublished{% endif %}"
                                onclick="window.location.href='{{ url_for('main.product_detail', product_id=product.id) }}'"
                                style="cursor: pointer;">
                                <td class="product-title-cell">
                                    <div class="table-product-title">{{ product.title }}</div>
                                    <div class="table-category">{{ product.product_category.name if
                                        product.product_category else 'Без категории' }}</div>
                                </td>
                                <td class="product-price-cell">
                                    <span class="table-price">{{ "%.2f"|format(product.price) }} ₽</span>
                                </td>
                                <td class="product-vat-cell">
                                    {% if product.vat_included %}
                                    <span class="vat-badge vat-included">+</span>
                                    {% else %}
                                    <span class="vat-badge vat-excluded">-</span>
                                    {% endif %}
                                </td>
                                <td class="product-condition-cell">
                                    {% if product.condition == 'new' %}
                                    <span class="condition-badge condition-new">Новое</span>
                                    {% else %}
                                    <span class="condition-badge condition-used">Б/У</span>
                                    {% endif %}
                                </td>
                                <td class="product-region-cell">{{ product.region or '—' }}</td>
                                <td class="product-city-cell">{{ product.city or '—' }}</td>
                                <td class="product-delivery-cell">
                                    {% if product.delivery %}
                                    <span class="delivery-badge delivery-yes">Есть</span>
                                    {% else %}
                                    <span class="delivery-badge delivery-no">Нет</span>
                                    {% endif %}
                                </td>
                                <td class="product-status-cell">
                                    <span class="status-badge status-{{ product.status }}">
                                        {{ product.status_text }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Пагинация для таблицы -->
                {% if products|length > 20 %}
                <div class="table-pagination">
                    <div class="pagination-info">
                        Показано 1-20 из {{ products|length }} товаров
                    </div>
                    <div class="pagination-controls">
                        <button class="pagination-btn prev-btn" disabled>← Назад</button>
                        <div class="page-numbers">
                            <span class="page-number active">1</span>
                            {% for page in range(2, (products|length // 20) + 2) %}
                            <span class="page-number">{{ page }}</span>
                            {% endfor %}
                        </div>
                        <button class="pagination-btn next-btn">Вперед →</button>
                    </div>
                </div>
                {% endif %}
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-icon"><i class="fas fa-box-open"></i></div>
                <h3>У вас пока нет товаров</h3>
                <p>Добавьте первый товар, чтобы начать продавать</p>
                <a href="{{ url_for('main.add_product') }}" class="btn-add-product">
                    <i class="fas fa-plus"></i> Добавить товар
                </a>
            </div>
            {% endif %}
        </main>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const viewButtons = document.querySelectorAll('.view-btn');
        const productsGrid = document.getElementById('productsGrid');
        const productsList = document.getElementById('productsList');
        const productsTable = document.getElementById('productsTable');

        // Загружаем сохраненный вид или используем 'grid' по умолчанию
        const savedView = localStorage.getItem('dashboardView') || 'grid';
        setActiveView(savedView);

        // Обработчики для кнопок переключения вида
        viewButtons.forEach(button => {
            button.addEventListener('click', function (e) {
                e.preventDefault();
                const viewType = this.getAttribute('data-view');
                setActiveView(viewType);
                localStorage.setItem('dashboardView', viewType);
            });
        });

        function setActiveView(viewType) {
            // Обновляем кнопки
            viewButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-view') === viewType) {
                    btn.classList.add('active');
                }
            });

            // Скрываем все виды
            if (productsGrid) productsGrid.style.display = 'none';
            if (productsList) productsList.style.display = 'none';
            if (productsTable) productsTable.style.display = 'none';

            // Показываем выбранный вид
            switch (viewType) {
                case 'grid':
                    if (productsGrid) productsGrid.style.display = 'grid';
                    break;
                case 'list':
                    if (productsList) productsList.style.display = 'block';
                    break;
                case 'table':
                    if (productsTable) productsTable.style.display = 'block';
                    // Инициализируем сортировку и пагинацию для таблицы
                    setTimeout(() => {
                        initializeTableSorting();
                        initializePagination();
                    }, 100);
                    break;
            }
        }

        // Активация текущего пункта меню
        const navItems = document.querySelectorAll('.nav-item');
        navItems.forEach(item => {
            item.addEventListener('click', function (e) {
                const link = this.querySelector('a');
                if (link && (link.getAttribute('href') === '#' || !link.getAttribute('href'))) {
                    e.preventDefault();
                    navItems.forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                }
            });
        });

        // Функция для сортировки таблицы
        function initializeTableSorting() {
            const sortableHeaders = document.querySelectorAll('.products-data-table th.sortable');
            if (!sortableHeaders.length) return;

            let currentSort = { column: null, direction: 'asc' };

            sortableHeaders.forEach(header => {
                header.addEventListener('click', function () {
                    const column = this.getAttribute('data-sort');
                    const table = this.closest('table');
                    if (!table) return;

                    const tbody = table.querySelector('tbody');
                    if (!tbody) return;

                    const rows = Array.from(tbody.querySelectorAll('tr'));

                    // Снимаем классы сортировки
                    sortableHeaders.forEach(h => h.classList.remove('sort-asc', 'sort-desc'));

                    // Определяем направление
                    if (currentSort.column === column) {
                        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.column = column;
                        currentSort.direction = 'asc';
                    }

                    this.classList.add(`sort-${currentSort.direction}`);

                    // Сортируем
                    rows.sort((a, b) => {
                        const aValue = getCellValue(a, column);
                        const bValue = getCellValue(b, column);
                        let comparison = 0;
                        if (aValue < bValue) comparison = -1;
                        if (aValue > bValue) comparison = 1;
                        return currentSort.direction === 'desc' ? comparison * -1 : comparison;
                    });

                    // Переставляем
                    rows.forEach(row => tbody.appendChild(row));
                });
            });

            function getCellValue(row, column) {
                const cell = row.querySelector(`.product-${column}-cell`);
                if (!cell) return '';

                switch (column) {
                    case 'title':
                        const titleElem = cell.querySelector('.table-product-title');
                        return titleElem ? titleElem.textContent.toLowerCase() : '';
                    case 'price':
                        const priceElem = cell.querySelector('.table-price');
                        if (!priceElem) return 0;
                        const priceText = priceElem.textContent;
                        return parseFloat(priceText.replace(/[^\d.]/g, '')) || 0;
                    case 'vat_included':
                        const vatElem = cell.querySelector('.vat-badge');
                        return vatElem ? (vatElem.textContent === '+' ? 1 : 0) : 0;
                    case 'condition':
                        const conditionElem = cell.querySelector('.condition-badge');
                        return conditionElem ? conditionElem.textContent.toLowerCase() : '';
                    case 'region':
                        return cell.textContent.toLowerCase();
                    case 'city':
                        return cell.textContent.toLowerCase();
                    case 'delivery':
                        const deliveryElem = cell.querySelector('.delivery-badge');
                        return deliveryElem ? (deliveryElem.textContent === 'Есть' ? 1 : 0) : 0;
                    case 'status':
                        const statusElem = cell.querySelector('.status-badge');
                        return statusElem ? statusElem.textContent.toLowerCase() : '';
                    default:
                        return cell.textContent.toLowerCase();
                }
            }
        }

        // Функция для пагинации таблицы
        function initializePagination() {
            try {
                const products = {{ products_json| tojson | safe if products_json else '[]'
            }};
        const pageNumbers = document.querySelectorAll('.page-number');
        const prevBtn = document.querySelector('.prev-btn');
        const nextBtn = document.querySelector('.next-btn');

        if (!products || products.length <= 20) return;

        let currentPage = 1;
        const itemsPerPage = 20;
        const totalPages = Math.ceil(products.length / itemsPerPage);

        function updateTable(page) {
            currentPage = page;
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageProducts = products.slice(startIndex, endIndex);

            const tbody = document.querySelector('.products-data-table tbody');
            if (!tbody) return;
            tbody.innerHTML = '';

            pageProducts.forEach(product => {
                const row = createTableRow(product);
                tbody.appendChild(row);
            });

            updatePaginationControls();
            const paginationInfo = document.querySelector('.pagination-info');
            if (paginationInfo) {
                paginationInfo.textContent =
                    `Показано ${startIndex + 1}-${Math.min(endIndex, products.length)} из ${products.length} товаров`;
            }
        }

        function createTableRow(product) {
            const row = document.createElement('tr');
            row.className = `table-product-row ${product.status !== 1 ? 'product-unpublished' : ''}`;
            row.style.cursor = 'pointer';
            row.onclick = () => window.location.href = `/product/${product.id}`;

            const titleCell = document.createElement('td');
            titleCell.className = 'product-title-cell';
            titleCell.innerHTML = `
                    <div class="table-product-title">${product.title || ''}</div>
                    <div class="table-category">${(product.product_category && product.product_category.name) || 'Без категории'}</div>
                `;

            const priceCell = document.createElement('td');
            priceCell.className = 'product-price-cell';
            const price = parseFloat(product.price) || 0;
            priceCell.innerHTML = `<span class="table-price">${price.toFixed(2)} ₽</span>`;

            const vatCell = document.createElement('td');
            vatCell.className = 'product-vat-cell';
            vatCell.innerHTML = product.vat_included ?
                '<span class="vat-badge vat-included">+</span>' :
                '<span class="vat-badge vat-excluded">-</span>';

            const conditionCell = document.createElement('td');
            conditionCell.className = 'product-condition-cell';
            conditionCell.innerHTML = (product.condition || 'new') === 'new' ?
                '<span class="condition-badge condition-new">Новое</span>' :
                '<span class="condition-badge condition-used">Б/У</span>';

            const regionCell = document.createElement('td');
            regionCell.className = 'product-region-cell';
            regionCell.textContent = product.region || '—';

            const cityCell = document.createElement('td');
            cityCell.className = 'product-city-cell';
            cityCell.textContent = product.city || '—';

            const deliveryCell = document.createElement('td');
            deliveryCell.className = 'product-delivery-cell';
            deliveryCell.innerHTML = product.delivery ?
                '<span class="delivery-badge delivery-yes">Есть</span>' :
                '<span class="delivery-badge delivery-no">Нет</span>';

            const statusCell = document.createElement('td');
            statusCell.className = 'product-status-cell';
            const statusMap = { 1: 'Опубликован', 2: 'Снят с публикации', 3: 'Готов к публикации' };
            const statusText = statusMap[product.status] || 'Неизвестно';
            statusCell.innerHTML = `<span class="status-badge status-${product.status}">${statusText}</span>`;

            [titleCell, priceCell, vatCell, conditionCell, regionCell, cityCell, deliveryCell, statusCell].forEach(cell => {
                row.appendChild(cell);
            });

            return row;
        }

        function updatePaginationControls() {
            pageNumbers.forEach((page, index) => {
                page.classList.toggle('active', index + 1 === currentPage);
            });
            if (prevBtn) prevBtn.disabled = currentPage === 1;
            if (nextBtn) nextBtn.disabled = currentPage === totalPages;
        }

        if (prevBtn) {
            prevBtn.addEventListener('click', () => {
                if (currentPage > 1) updateTable(currentPage - 1);
            });
        }
        if (nextBtn) {
            nextBtn.addEventListener('click', () => {
                if (currentPage < totalPages) updateTable(currentPage + 1);
            });
        }
        pageNumbers.forEach((page, index) => {
            page.addEventListener('click', () => {
                if (index + 1 !== currentPage) updateTable(index + 1);
            });
        });

        updateTable(1);
    } catch (error) {
        console.error('Ошибка при инициализации пагинации:', error);
    }
    }
});
</script>
{% endblock %}