<div class="product-grid-v2">
    {% for product in products %}
    <div class="product-card-v2" onclick="location.href='{{ url_for('main.product_detail', product_id=product.id) }}'">

        <!-- Image Area -->
        <div class="card-image-wrapper">
            <!-- Location Overlay -->
            <div class="location-overlay-v2">
                {% if product.city %}{{ product.city }}{% endif %}
                {% if product.region and product.city %}, {% endif %}
                {% if product.region %}{{ product.region }}{% endif %}
            </div>

            <!-- Favorite Badge -->
            {% if current_user.is_authenticated and product in current_user.favorited_products %}
            <div class="favorite-btn-v2" title="–í –∏–∑–±—Ä–∞–Ω–Ω–æ–º">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="#FF0000" stroke="#FF0000" stroke-width="1.5">
                    <path
                        d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" />
                </svg>
            </div>
            {% endif %}

            <!-- Image Logic -->
            {% set image_list = product.images | deserialize_images %}
            {% if image_list | length > 0 %}
            <img src="{{ url_for('main.serve_uploaded_file', filename=image_list[0]) }}" alt="{{ product.title }}"
                onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <div class="no-photo-v2" style="display: none;">
                <span style="font-size:32px; opacity:0.6;">üñºÔ∏è</span>
            </div>
            {% else %}
            <div class="no-photo-v2">
                <span style="font-size:32px; opacity:0.6;">üñºÔ∏è</span>
            </div>
            {% endif %}
        </div>

        <!-- Info Area -->
        <div class="card-info">
            <!-- Title -->
            <div class="card-title">{{ product.title }}</div>

            <!-- Price -->
            <div class="card-price">
                {{ "%.0f"|format(product.price) }} ‚ÇΩ
            </div>

            <!-- VAT / Condition (Optional, kept minimal for compact view) -->
            <!-- <div style="font-size: 10px; color: #999;">
                {{ '–° –ù–î–°' if product.vat_included else '–ë–µ–∑ –ù–î–°' }}
            </div> -->

            <!-- Meta: Date & Views -->
            <div class="card-meta">
                <span>{{ product.created_at.strftime('%d.%m') }}</span>
                <span style="margin-left: auto; display: flex; align-items: center; gap: 4px;">
                    <img src="{{ url_for('static', filename='icons/eye_icon.svg') }}" alt=""
                        style="width: 12px; height: 12px; opacity: 0.6;">
                    {{ product.view_count if product.view_count else 0 }}
                </span>
            </div>
        </div>

    </div>
    {% endfor %}
</div>