{% extends "base.html" %}
{% block title %}ASAUDA - Система быстрых продаж{% endblock %}
{% block styles %}
<style>
    /* Используем стили из style.css, добавляем только специфичные для главной страницы */
    .hero-section {
        background: linear-gradient(135deg, var(--avito-blue) 0%, var(--avito-blue-hover) 100%);
        padding: 60px 0;
        color: white;
        text-align: center;
    }

    .hero-description {
        font-size: 18px;
        margin-bottom: 32px;
        opacity: 0.9;
    }

    /* Search Section - ПОЛНАЯ ШИРИНА */
    .search-section {
        background: var(--background);
        border-bottom: 1px solid var(--border);
        padding: 10px;
        margin-bottom: 5px;
    }

    .search-row-full {
        width: 100%;
        background: white;
        padding: 10px 0;
        box-shadow: var(--shadow-light);
    }

    .search-row {
        display: flex;
        align-items: center;
        width: 100%;
        gap: 12px;
        margin: 0 auto;
    }

    /* Увеличиваем контейнер поиска */
    .search-group {
        flex: 1;
        min-width: 0;
        display: flex;
        height: 48px;
        border-radius: 8px;
        overflow: hidden;
        border: 2px solid var(--avito-blue);
        background: white;
    }

    .search-field {
        flex: 1;
        min-width: 0;
        border: none;
        outline: none;
        padding: 0 16px;
        font-size: 16px;
        background: transparent;
        color: var(--text-primary);
    }

    .category-filter {
        flex: 0 0 220px;
        height: 48px;
        padding: 0 16px;
        border: 2px solid var(--border);
        border-radius: 8px;
        font-size: 16px;
        background: white;
        cursor: pointer;
        color: var(--text-primary);
    }

    /* ===== СТИЛИ ДЛЯ КАТЕГОРИЙ ===== */
    .categories-section {
        background: white;
        padding: 10px 0;
        border-bottom: 1px solid var(--border);
        margin-bottom: 10px;
    }

    .categories-container {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .categories-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 5px;
    }

    .categories-grid {
        display: flex !important;
        flex-wrap: wrap !important;
        gap: 12px !important;
        justify-content: flex-start;
        width: 100%;
    }



    .category-mobile-name {
        display: none;
    }

    /* Элемент категории (Плитка) */
    .main-category-item {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        width: auto;
        min-width: fit-content;
        /* Dynamic width */
        max-width: 300px;
        /* Slightly reduced max-width */
        height: 60px;
        /* Reduced from 70px (- ~15%) */
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
        position: relative;
        padding: 4px 10px;
        /* Reduced padding */
        gap: 10px;
        /* Consistent gap matching padding */
        background: white;
        border-radius: 10px;
        /* Slightly smaller radius */
        border: 1px solid var(--border);
        flex-grow: 1;
        /* Allow stretch */
    }

    .main-category-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 87, 255, 0.25);
        background: var(--avito-blue);
        border-color: var(--avito-blue);
        z-index: 2;
    }

    .main-category-item:hover .category-tile-name {
        color: white;
    }

    .category-tile-name {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        white-space: normal;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        line-height: 1.25;
        margin-right: 0;
        z-index: 2;
        transition: color 0.2s ease;
        max-width: 100%;
    }

    /* Иконка категории */
    .main-category-icon {
        width: 44px;
        /* Smaller icon for desktop tile */
        height: 44px;
        border-radius: 8px;
        background: white;
        /* White background for icon */
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 0;
        border: none;
        overflow: hidden;
        margin-left: 0;
        /* Removed auto margin property */
        flex-shrink: 0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .main-category-item:hover .main-category-icon {
        transform: scale(1.05);
        /* Gentle scale */
        border-color: transparent;
        box-shadow: none;
    }

    /* Изображение внутри иконки */
    .main-category-icon img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 6px;
        transition: all 0.3s ease;
        filter: grayscale(0%);
        /* Always color */
    }

    .main-category-item:hover .main-category-icon img {
        transform: scale(1.1);
    }

    /* Заглушка (буква) */
    .main-category-fallback {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        font-weight: 700;
        color: white;
        border-radius: 6px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .main-category-item:hover .main-category-fallback {
        transform: scale(1.1);
    }

    /* SVG "Все категории" */
    .main-category-icon svg {
        width: 28px;
        height: 28px;
        transition: all 0.3s ease;
        filter: none;
        color: var(--avito-blue);
    }

    .main-category-item:hover .main-category-icon svg {
        transform: scale(1.1);
    }

    /* Активная (выбранная) категория */
    .main-category-item.active {
        background: #eef2ff;
        border-color: var(--avito-blue);
        box-shadow: 0 4px 12px rgba(0, 87, 255, 0.15);
    }

    .main-category-item.active .main-category-icon {
        border: none;
        box-shadow: none;
    }

    /* Падающий текст (заглушка) */
    .category-fallback {
        font-size: 18px;
        font-weight: bold;
        color: #ddd;
    }

    /* Production-matched Mobile Styles */
    @media (max-width: 768px) {
        .main-category-item {
            width: 140px;
            height: 85px;
            flex: 0 0 auto;
            padding: 10px;
            background: white;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            border: 1px solid var(--border);
            min-width: 0;
            /* Override desktop min-width */
            max-width: none;
            /* Override desktop max-width */
        }

        .main-category-item.active {
            background: #eef2ff;
            border-color: var(--avito-blue);
        }

        /* Adjust inner elements for mobile vertical layout */
        .category-tile-name {
            font-size: 13px;
            margin-right: 0;
            margin-bottom: 5px;
            white-space: normal;
        }

        .main-category-icon {
            margin-left: 0;
            align-self: flex-end;
            /* Push icon to bottom right like original design or keep standard? Production said justify-content: space-between */
        }
    }

    .main-category-fallback {
        font-size: 28px;
        font-weight: 700;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 18px;
        transition: all 0.2s ease;
        filter: grayscale(100%) opacity(0.7);
    }

    .main-category-item:hover .main-category-fallback {
        transform: scale(1.1);
        background: linear-gradient(135deg, var(--avito-blue) 0%, #0047cc 100%);
        filter: grayscale(0%) opacity(1);
    }

    /* Тултип для названия категории */
    .main-category-tooltip {
        position: absolute;
        bottom: -35px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.85);
        color: white;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
        pointer-events: none;
        z-index: 100;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .main-category-tooltip::after {
        content: '';
        position: absolute;
        top: -5px;
        left: 50%;
        transform: translateX(-50%);
        border-left: 5px solid transparent;
        border-right: 5px solid transparent;
        border-bottom: 5px solid rgba(0, 0, 0, 0.85);
    }

    .main-category-item:hover .main-category-tooltip {
        opacity: 1;
        visibility: visible;
        transform: translateX(-50%) translateY(-2px);
    }

    /* ===== АДАПТИВНОСТЬ ДЛЯ КАТЕГОРИЙ ===== */
    @media (max-width: 768px) {

        /* FIX: Mobile Search Bar Layout */
        .search-row {
            flex-direction: column;
            align-items: stretch;
            gap: 10px;
        }

        .category-filter {
            width: 100%;
            margin-bottom: 0;
            flex: none;
        }

        .search-group {
            width: 100%;
            flex: none;
        }

        .location-button {
            width: 100%;
            justify-content: center;
            margin-top: 0;
            flex: none;
            background: #f0f0f0;
            /* Более заметная кнопка на мобильном */
            height: 48px;
            /* Единая высота */
        }

        /* Categories Styles */
        /* Categories Styles - Horizontal Scroll & Tiles */
        .categories-grid {
            display: flex !important;
            flex-wrap: nowrap !important;
            overflow-x: auto;
            justify-content: flex-start !important;
            gap: 12px !important;
            padding: 0 4px 10px 4px;
            /* Padding for scroll spacing */
            margin: 0 -10px;
            /* Slight bleed */
            scrollbar-width: none;
            /* Firefox */
        }

        .categories-grid::-webkit-scrollbar {
            display: none;
        }

        .main-category-item {
            width: 140px;
            /* Tile width */
            height: 85px;
            /* Tile height */
            flex: 0 0 auto;
            padding: 10px;
            background: white;
            /* White on mobile */
            /* Light tile background */
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            border: 1px solid var(--border);
        }

        /* Text inside tile */
        .category-mobile-name {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            font-size: 13px;
            font-weight: 600;
            line-height: 1.2;
            color: var(--text-primary);
            /* Dark text */
            z-index: 2;
            text-align: left;
            margin-right: 30px;
            /* Space for image */
        }

        /* Icon adjustment for tile */
        .main-category-icon {
            width: 50px;
            height: 50px;
            border-radius: 0;
            position: absolute;
            bottom: -5px;
            right: -5px;
            background: white;
            /* White background for icon on mobile */
            border: none;
            box-shadow: none !important;
            z-index: 1;
        }

        .main-category-icon-inner {
            width: 100%;
            height: 100%;
        }

        .main-category-icon img,
        .main-category-fallback {
            border-radius: 8px;
            /* Slight radius */
        }

        /* Remove borders/effects from icon wrapper on mobile */
        .main-category-item:hover .main-category-icon {
            border-color: transparent;
            transform: none;
        }

        /* Fallback styling tweaks */
        .main-category-fallback {
            font-size: 20px;
            border-radius: 50%;
            /* Circle fallback looks decent */
        }

        .main-category-tooltip {
            display: none !important;
            /* Hide tooltip on mobile */
        }

        /* Active state for tile */
        .main-category-item.active {
            background: #eef2ff;
            border-color: var(--avito-blue);
        }
    }

    @media (max-width: 480px) {
        .categories-grid {
            gap: 10px !important;
        }

        .main-category-item {
            width: 70px;
        }

        .main-category-icon {
            width: 60px;
            height: 60px;
            border-radius: 14px;
        }

        .main-category-icon img,
        .main-category-fallback {
            border-radius: 12px;
        }

        .main-category-fallback {
            font-size: 20px;
        }

        .main-category-icon svg {
            width: 30px;
            height: 30px;
        }
    }

    /* УБИРАЕМ ЛЕВЫЙ БЛОК КАТЕГОРИЙ - ВЕСЬ ЭКРАН ДЛЯ КОНТЕНТА */
    .content-container {
        width: 100%;
        flex-grow: 1;
    }

    /* Стили для переключения видов */
    /* Стили для переключения видов */
    .view-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #F0F0F0;
    }

    .view-toggle {
        display: flex;
        gap: 2px;
        background: #F8F9FA;
        border-radius: 6px;
        padding: 2px;
        border: 1px solid #E0E0E0;
    }

    .view-btn {
        background: none;
        border: none;
        padding: 4px 6px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s ease;
        color: #666666;
    }

    .view-btn:hover {
        background: #F0F0F0;
        color: #1A1A1A;
    }

    .view-btn.active {
        background: #0057FF;
        color: white;
    }

    /* Стили для представления плиткой - 4 КОЛОНКИ В РЯДУ */
    .products-grid-view {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
        margin-bottom: 20px;
    }

    /* Специфичные стили для представления списком */
    .products-list-view .product-card {
        display: flex;
        flex-direction: row;
        min-height: 150px;
        align-items: stretch;
    }

    .products-list-view .product-image {
        width: 150px;
        height: 150px;
        flex-shrink: 0;
        min-width: 150px;
    }

    .products-list-view .product-info {
        flex: 1;
        padding: 15px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        min-width: 0;
    }

    .products-list-view .product-name {
        -webkit-line-clamp: 2;
        display: -webkit-box;
        -webkit-box-orient: vertical;
        overflow: hidden;
        margin-bottom: 8px;
    }

    /* Таблица товаров */
    .products-data-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
    }

    .products-data-table thead {
        background: #F8F9FA;
        border-bottom: 2px solid #E0E0E0;
    }

    .products-data-table th {
        padding: 16px;
        text-align: left;
        font-weight: 600;
        font-size: 14px;
        color: #1A1A1A;
        border-right: 1px solid #E0E0E0;
        position: relative;
        cursor: pointer;
        user-select: none;
    }

    .products-data-table th.sortable:hover {
        background: #F0F0F0;
    }

    .products-data-table th:last-child {
        border-right: none;
    }

    .table-header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .header-text {
        flex: 1;
    }

    .sort-icon {
        margin-left: 8px;
        font-size: 12px;
        opacity: 0.5;
    }

    .products-data-table th.sort-asc .sort-icon::before {
        content: "↑";
        opacity: 1;
    }

    .products-data-table th.sort-desc .sort-icon::before {
        content: "↓";
        opacity: 1;
    }

    .products-data-table tbody tr {
        border-bottom: 1px solid #F0F0F0;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    .products-data-table tbody tr:hover {
        background: #F8F9FA;
    }

    .products-data-table tbody tr:last-child {
        border-bottom: none;
    }

    .products-data-table td {
        padding: 16px;
        vertical-align: middle;
        border-right: 1px solid #F0F0F0;
    }

    .products-data-table td:last-child {
        border-right: none;
    }

    /* Стили для ячеек таблицы */
    .table-product-title {
        font-weight: 600;
        font-size: 15px;
        color: #1A1A1A;
        margin-bottom: 4px;
    }

    .table-category {
        font-size: 12px;
        color: #999999;
    }

    .table-price {
        font-weight: 700;
        font-size: 16px;
        color: #0057FF;
    }

    /* Бейджи для статусов */
    .vat-badge,
    .condition-badge,
    .delivery-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
    }

    .vat-badge.vat-included {
        background: #E6F7E9;
        color: #00A326;
    }

    .vat-badge.vat-excluded {
        background: #FFF2E6;
        color: #FF6B00;
    }

    .condition-badge.condition-new {
        background: #E6F2FF;
        color: #0057FF;
    }

    .condition-badge.condition-used {
        background: #F2F2F2;
        color: #666666;
    }

    .delivery-badge.delivery-yes {
        background: #E6F7E9;
        color: #00A326;
    }

    .delivery-badge.delivery-no {
        background: #FFE6E6;
        color: #FF0000;
    }

    .location-button {
        flex: 0 0 auto;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 13px;
        color: #666;
        background: #f8f9fa;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
        min-height: 28px;
        border: 1px solid transparent;
    }

    /* Пагинация для таблицы */
    .table-pagination {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 16px;
        border-top: 1px solid #E0E0E0;
        background: #F8F9FA;
    }

    .pagination-info {
        font-size: 14px;
        color: #666666;
    }

    .pagination-controls {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .pagination-btn {
        padding: 8px 16px;
        background: white;
        border: 1px solid #E0E0E0;
        border-radius: 6px;
        font-size: 14px;
        color: #1A1A1A;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .pagination-btn:hover:not(:disabled) {
        background: #F0F0F0;
        border-color: #CCCCCC;
    }

    .pagination-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .page-numbers {
        display: flex;
        gap: 4px;
    }

    .page-number {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        color: #666666;
        cursor: pointer;
        border-radius: 6px;
        transition: all 0.2s ease;
    }

    .page-number:hover {
        background: #F0F0F0;
    }

    .page-number.active {
        background: #0057FF;
        color: white;
    }

    /* === Стили для модального окна локации === */
    .location-search {
        position: relative;
        margin: 20px;
    }

    #locationInput {
        width: 100%;
        padding: 12px 40px 12px 14px;
        border: 2px solid var(--border);
        border-radius: 8px;
        font-size: 16px;
        outline: none;
        transition: border-color 0.2s ease;
    }

    #locationInput:focus {
        border-color: var(--avito-blue);
    }

    .clear-btn {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        font-size: 20px;
        color: #999;
        cursor: pointer;
        padding: 4px;
        line-height: 1;
    }

    .clear-btn:hover {
        color: #666;
    }

    .location-suggestions {
        margin: 0 20px 20px;
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: white;
    }

    .suggestion-item {
        padding: 14px 16px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: all 0.2s ease;
        font-size: 14px;
    }

    .suggestion-item:hover {
        background: #f8f9fa;
        padding-left: 20px;
    }

    .suggestion-item:last-child {
        border-bottom: none;
    }

    .suggestion-item.no-results {
        color: #999;
        text-align: center;
        cursor: default;
    }

    .suggestion-item.no-results:hover {
        background: white;
        padding-left: 16px;
    }

    .loading-indicator {
        text-align: center;
        padding: 20px;
        color: #666;
    }

    .loading-indicator::after {
        content: '...';
        animation: dots 1.5s steps(4, end) infinite;
    }

    @keyframes dots {

        0%,
        20% {
            content: '';
        }

        40% {
            content: '.';
        }

        60% {
            content: '..';
        }

        80%,
        100% {
            content: '...';
        }
    }

    /* Стили для текущего местоположения */
    .suggestion-item.current-location {
        background-color: #e6f2ff;
        font-weight: 600;
        border-left: 4px solid #0057FF;
    }

    .suggestion-item.current-location:hover {
        background-color: #d1e6ff;
    }

    .suggestion-separator {
        padding: 10px 16px;
        font-size: 12px;
        color: #666;
        background-color: #f8f9fa;
        border-top: 1px solid #e0e0e0;
        border-bottom: 1px solid #e0e0e0;
        margin-top: 5px;
    }

    .suggestion-item.all-regions {
        font-weight: 600;
        color: #0057FF;
        background-color: #f0f7ff;
        border-left: 4px solid #0057FF;
    }

    .suggestion-item.all-regions:hover {
        background-color: #e6f2ff;
    }

    /* ===== ИСПРАВЛЕНИЯ ДЛЯ ОТОБРАЖЕНИЯ СПИСКОВ И ТАБЛИЦ ===== */

    /* Плиточный вид */
    #productsGridView {
        display: block;
    }

    /* Списковый вид */
    #productsListView {
        display: none;
    }

    /* Табличный вид */
    #productsTableView {
        display: none;
    }

    /* Стили для плиточного вида */
    .product-card {
        background: white;
        border: 1px solid var(--border);
        border-radius: 12px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: var(--shadow-light);
    }

    .product-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    /* Стили для спискового вида */
    .products-list-view {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    .list-product-card {
        background: white;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px;
        display: flex;
        align-items: center;
        gap: 20px;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: var(--shadow-light);
    }

    .list-product-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .list-product-image {
        width: 120px;
        height: 120px;
        flex-shrink: 0;
        border-radius: 8px;
        overflow: hidden;
        background: var(--background-secondary);
        position: relative;
    }

    .list-product-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .no-photo-small {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f0f0f0;
        color: #999;
    }

    .list-product-info {
        flex: 1;
        min-width: 0;
    }

    .list-product-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 8px;
        line-height: 1.4;
    }

    .list-product-description {
        font-size: 14px;
        color: var(--text-secondary);
        margin-bottom: 12px;
        line-height: 1.4;

        .products-list-view .product-name {
            -webkit-line-clamp: 2;
            line-clamp: 2;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .list-product-meta {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .list-product-price {
            width: 150px;
            flex-shrink: 0;
            text-align: right;
        }

        .list-product-price .price-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--avito-blue);
            display: block;
            margin-bottom: 8px;
        }

        .list-product-actions {
            width: 120px;
            flex-shrink: 0;
            display: flex;
            justify-content: flex-end;
        }

        /* Стили для табличного вида */
        .products-table-container {
            display: block;
            width: 100%;
            overflow-x: auto;
            margin-bottom: 20px;
        }

        .table-wrapper {
            min-width: 1000px;
        }

        /* Стили для локации на карточке товара */
        .product-image {
            position: relative;
            height: 200px;
            overflow: hidden;
            background: #F8F9FA;
            display: block;
        }

        .product-location-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.5) 0%, rgba(0, 0, 0, 0) 100%);
            color: white;
            padding: 10px 12px 20px;
            font-size: 12px;
            z-index: 1;
            pointer-events: none;
        }

        .location-text {
            background: rgba(0, 0, 0, 0.6);
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
            font-weight: 500;
            backdrop-filter: blur(2px);
            max-width: calc(100% - 30px);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Значок избранного должен быть поверх локации */
        .favorite-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            z-index: 2;
        }


        /* ========================================= */
        /* АДАПТИВНОСТЬ ДЛЯ МОБИЛЬНЫХ - ИСПРАВЛЕНО */
        /* ========================================= */

        @media (max-width: 768px) {

            /* Плиточный вид: 1 колонка на мобильных */
            .products-grid-view {
                grid-template-columns: 1fr !important;
                gap: 20px !important;
            }

            /* Адаптация спискового вида на мобильных */
            .list-product-card {
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 15px !important;
            }

            .list-product-image {
                width: 100% !important;
                height: 200px !important;
                border-radius: 8px 8px 0 0 !important;
                margin: -16px -16px 0 -16px !important;
                width: calc(100% + 32px) !important;
            }

            .list-product-price,
            .list-product-actions {
                width: 100% !important;
                text-align: left !important;
                padding-left: 0 !important;
                margin-top: 10px !important;
            }

            .list-product-actions {
                justify-content: flex-start !important;
            }

            /* Адаптация переключения видов на мобильных */
            .view-controls {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 10px !important;
            }

            /* Адаптация таблицы для мобильных */
            .products-data-table {
                display: block !important;
                overflow-x: auto !important;
            }

            .products-data-table th,
            .products-data-table td {
                white-space: nowrap !important;
                min-width: 100px !important;
                padding: 12px 8px !important;
                font-size: 13px !important;
            }

            .table-pagination {
                flex-direction: column !important;
                gap: 10px !important;
                align-items: stretch !important;
            }

            .pagination-controls {
                justify-content: center !important;
            }

            /* Адаптивность модального окна локации для мобильных */
            #locationModal .modal-content {
                margin: 20% auto !important;
                width: 95% !important;
                max-width: 95% !important;
                border-radius: 12px !important;
            }

            #locationModal .modal-header {
                padding: 20px 20px 12px !important;
            }

            #locationModal .modal-header h3 {
                font-size: 18px !important;
            }

            .location-search {
                margin: 0 20px 16px !important;
            }

            #locationInput {
                padding: 12px 40px 12px 14px !important;
                font-size: 15px !important;
            }

            .location-suggestions {
                margin: 0 20px 20px !important;
                max-height: 300px !important;
            }

            .suggestion-item {
                padding: 14px 16px !important;
                font-size: 14px !important;
            }

            .suggestion-item:hover {
                padding-left: 20px !important;
            }

            .product-location-overlay {
                padding: 8px 10px 16px !important;
                font-size: 11px !important;
            }

            .location-text {
                padding: 3px 6px !important;
            }
        }

        /* ========================================= */
        /* ПЛАНШЕТЫ (5 колонок для категорий) */
        /* ========================================= */

        @media (min-width: 769px) and (max-width: 1024px) {
            .products-grid-view {
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 20px !important;
            }
        }

        /* ========================================= */
        /* ДЕСКТОПЫ (7 колонок для категорий) */
        /* ========================================= */

        @media (min-width: 1025px) {
            .listings-section .products-grid-view {
                grid-template-columns: repeat(4, 1fr) !important;
                gap: 16px !important;
            }
        }

        /* Для очень маленьких экранов (до 480px) */
        @media (max-width: 480px) {
            .products-grid-view {
                gap: 16px !important;
            }

            .product-card {
                border-radius: 10px !important;
            }

            .product-image {
                height: 180px !important;
            }

            .list-product-image {
                height: 180px !important;
            }
        }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="hero-section">
    <div class="container">
        <h1 class="page-title">Бесплатная система продажи остатков</h1>
        <p class="hero-description">Найдите выгодные предложения от производителей и поставщиков</p>
    </div>
</div>
<!-- Search Section -->
<div class="search-section">
    <div class="search-row-full">
        <div class="container">
            <div class="search-row">
                <!-- Окно выбора категории -->
                <select class="category-filter" id="categoryFilter">
                    <option value="">Все категории</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}" {% if request.args.get('category_id')==category.id|string
                        %}selected{% endif %}>
                        {{ category.display_name }}
                    </option>
                    {% endfor %}
                </select>
                <!-- Строка поиска -->
                <div class="search-group">
                    <input type="text" class="search-field" placeholder="Найти товары..." id="searchInput"
                        value="{{ search_term or '' }}">
                    <button class="search-btn">
                        <span class="search-btn-icon">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                <path
                                    d="M15 15L11 11M13 6.5C13 9.53757 10.5376 12 7.5 12C4.46243 12 2 9.53757 2 6.5C2 3.46243 4.46243 1 7.5 1C10.5376 1 13 3.46243 13 6.5Z"
                                    stroke="white" stroke-width="2" stroke-linecap="round" />
                            </svg>
                        </span>
                        <span class="search-btn-text">Найти</span>
                    </button>
                </div>
                <!-- Местоположение -->
                <div id="locationDisplay" class="location-button" title="Изменить город">
                    <span id="locationText">{{ current_user.location or 'Казань' }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- WRAPPER FOR 2-COLUMN LAYOUT -->
<div class="container-fluid mt-2 px-4">
    <div class="main-layout-wrapper" style="display: flex; gap: 20px; align-items: flex-start;">

        <!-- LEFT COLUMN: Categories + Content -->
        <div class="layout-main-column" style="flex: 1; min-width: 0;">

            <!-- Блок категорий -->
            <div class="categories-section"
                style="border-radius: 12px; border: 1px solid var(--border); margin-bottom: 8px;">
                <div class="container-fluid px-2"> <!-- Changed to fluid/px-2 for better fit -->
                    <div class="categories-container">

                        <div class="categories-grid" id="categoriesGrid"
                            style="display: flex; flex-wrap: nowrap; overflow-x: auto; gap: 12px; align-items: stretch;">
                            <!-- Все категории -->
                            <div class="main-category-item {% if not request.args.get('category_id') %}active{% endif %}"
                                data-category-id="" data-category-name="Все категории"
                                onclick="selectCategory(this, '')" title="Все категории">
                                <span class="category-tile-name">Все<br>категории</span>
                                <div class="main-category-icon">
                                    <div class="main-category-icon-inner">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"
                                            stroke-linecap="round" stroke-linejoin="round">
                                            <rect x="3" y="3" width="7" height="7" rx="1"></rect>
                                            <rect x="14" y="3" width="7" height="7" rx="1"></rect>
                                            <rect x="14" y="14" width="7" height="7" rx="1"></rect>
                                            <rect x="3" y="14" width="7" height="7" rx="1"></rect>
                                        </svg>
                                    </div>
                                </div>
                            </div>

                            <!-- Родительские категории из базы данных -->
                            {% for category in root_categories %}
                            <div class="main-category-item {% if request.args.get('category_id') == category.id|string %}active{% endif %}"
                                data-category-id="{{ category.id }}" data-category-name="{{ category.name }}"
                                onclick="selectCategory(this, '{{ category.id }}')" title="{{ category.name }}">
                                <span class="category-tile-name">{{ category.name }}</span>
                                <div class="main-category-icon">
                                    <div class="main-category-icon-inner">
                                        {% if category.image %}
                                        <img src="{{ url_for('main.get_category_image_by_size', category_id=category.id, size='thumbnail') }}"
                                            alt="{{ category.name }}"
                                            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                        <div class="category-fallback" style="display: none;">
                                            {{ category.name|first|upper }}
                                        </div>
                                        {% else %}
                                        <div class="category-fallback">
                                            {{ category.name|first|upper }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>

                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="content-container">
                <div class="listings-section">

                    {% if products %}
                    <!-- Grid View -->
                    <div id="productsGridView">
                        {% include 'partials/product_grid.html' %}
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <h4>Товары не найдены</h4>
                        <p>Попробуйте изменить параметры поиска или выбрать другую категорию</p>
                        {% if not current_user.is_authenticated %}
                        <a href="{{ url_for('auth.login') }}" class="btn-primary mt-3">Войти, чтобы добавить
                            товар</a>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div> <!-- End Left Column -->

        <!-- RIGHT COLUMN: Sidebar -->
        <div class="layout-sidebar" style="width: 300px; flex-shrink: 0; display: none;">

            <!-- Ad Block -->
            <!-- Ad Block (Banner) -->
            {% if sidebar_banner %}
            <div class="ad-block mb-4">
                <img src="{{ url_for('static', filename='img/ads/' + sidebar_banner) }}" alt="Реклама"
                    class="img-fluid rounded shadow-sm" style="width: 100%; border: 1px solid #e0e0e0;">
            </div>
            {% else %}
            <!-- Placeholder if no banner -->
            <div class="ad-block"
                style="background: white; border-radius: 8px; border: 1px solid #e0e0e0; height: 300px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">
                <div style="text-align: center; color: #999;">
                    <span style="font-size: 14px; display: block; margin-bottom: 8px;">Реклама</span>
                    <span style="font-size: 24px; opacity: 0.3;">Место для баннера</span>
                </div>
            </div>
            {% endif %}

            <!-- News Block -->
            <div class="news-block"
                style="background: white; border-radius: 8px; border: 1px solid #e0e0e0; padding: 20px; position: sticky; top: 20px;">
                <h5 style="font-size: 16px; font-weight: 700; margin-bottom: 16px; color: #1A1A1A;">Новости</h5>

                <div class="news-item"
                    style="margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #f0f0f0;">
                    <div style="font-size: 11px; color: #999; margin-bottom: 4px;">15 декабря 2025</div>
                    <a href="#"
                        style="font-size: 13px; font-weight: 500; color: #333; text-decoration: none; line-height: 1.4; display: block;">
                        Запуск системы безопасных сделок для юридических лиц
                    </a>
                </div>

                <div class="news-item"
                    style="margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #f0f0f0;">
                    <div style="font-size: 11px; color: #999; margin-bottom: 4px;">12 декабря 2025</div>
                    <a href="#"
                        style="font-size: 13px; font-weight: 500; color: #333; text-decoration: none; line-height: 1.4; display: block;">
                        Обновление категорий: добавлено оборудование для HoReCa
                    </a>
                </div>

                <div class="news-item">
                    <div style="font-size: 11px; color: #999; margin-bottom: 4px;">10 декабря 2025</div>
                    <a href="#"
                        style="font-size: 13px; font-weight: 500; color: #333; text-decoration: none; line-height: 1.4; display: block;">
                        Технические работы завершены
                    </a>
                </div>

                <a href="#"
                    style="display: block; margin-top: 16px; font-size: 13px; color: var(--avito-blue); text-decoration: none; font-weight: 500;">
                    Все новости &rarr;
                </a>
            </div>
        </div>

    </div>
</div>

<style>
    /* Responsive Sidebar Visibility */
    .layout-sidebar {
        display: block !important;
    }

    @media (max-width: 992px) {
        .main-layout-wrapper {
            flex-direction: column;
        }

        .layout-sidebar {
            width: 100% !important;
            display: none !important;
            /* Hide on mobile/tablet for now or move to bottom */
        }

        .ad-block {
            height: 200px !important;
            /* Smaller on mobile if shown */
        }

        .layout-main-column {
            width: 100%;
        }
    }
</style>


<style>
    /* === NEW V2 STYLES FOR 4-COLUMN GRID === */
    /* Strict grid definition */
    .product-grid-v2 {
        display: grid !important;
        grid-template-columns: repeat(4, 1fr) !important;
        gap: 12px !important;
        width: 100% !important;
    }

    /* Compact Card Styles */
    .product-card-v2 {
        background: white;
        border: 1px solid #e0e0e0;
        /* Explicit border color */
        border-radius: 8px;
        /* Smaller radius */
        overflow: hidden;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        display: flex;
        flex-direction: column;
        height: 100%;
        /* Ensure full height in grid */
        position: relative;
        /* For overlays */
    }

    .product-card-v2:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
        border-color: var(--avito-blue);
    }

    /* Image area */
    .product-card-v2 .card-image-wrapper {
        position: relative;
        width: 100%;
        padding-top: 100%;
        /* Square aspect ratio 1:1 */
        background: #f8f9fa;
        overflow: hidden;
    }

    .product-card-v2 .card-image-wrapper img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .product-card-v2 .no-photo-v2 {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: #f0f0f0;
        color: #999;
    }

    /* Overlays */
    .product-card-v2 .location-overlay-v2 {
        position: absolute;
        top: 6px;
        bottom: auto;
        left: 6px;
        right: auto;
        background: rgba(0, 0, 0, 0.6);
        padding: 4px 8px;
        color: white;
        font-size: 11px;
        z-index: 2;
        pointer-events: none;
        border-radius: 6px;
        text-align: left;
        max-width: calc(100% - 40px);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .product-card-v2 .favorite-btn-v2 {
        position: absolute;
        top: 6px;
        right: 6px;
        width: 28px;
        height: 28px;
        background: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        z-index: 5;
        cursor: pointer;
    }

    /* Info area */
    .product-card-v2 .card-info {
        padding: 8px 10px;
        /* Reduced padding */
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        gap: 4px;
    }

    .product-card-v2 .card-price {
        font-size: 16px;
        /* Slightly smaller than 20px */
        font-weight: 700;
        color: #1A1A1A;
        line-height: 1.2;
    }

    .product-card-v2 .card-title {
        font-size: 13px;
        color: #1A1A1A;
        line-height: 1.3;
        margin-bottom: 2px;
        /* Line clamp 2 lines */
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        height: 34px;
        /* Fixed height for 2 lines */
    }

    .product-card-v2 .card-meta {
        font-size: 11px;
        color: #8D8D8D;
        /* Avito grey */
        margin-top: auto;
        /* Push to bottom */
        display: flex;
        align-items: center;
        gap: 8px;
    }

    /* Responsive Adjustments */
    @media (max-width: 1200px) {
        .product-grid-v2 {
            grid-template-columns: repeat(3, 1fr) !important;
        }
    }

    @media (max-width: 992px) {
        .product-grid-v2 {
            grid-template-columns: repeat(2, 1fr) !important;
        }
    }

    @media (max-width: 768px) {
        .product-grid-v2 {
            grid-template-columns: repeat(2, 1fr) !important;
            gap: 8px !important;
        }

        .product-card-v2 .card-image-wrapper {
            padding-top: 100%;
            /* Keep square on mobile? */
        }
    }

    @media (max-width: 480px) {

        /* Mobile: 2 columns is standard for apps */
        .product-grid-v2 {
            grid-template-columns: repeat(2, 1fr) !important;
        }

        .product-card-v2 .card-info {
            padding: 8px;
        }
    }

    @media (min-width: 769px) {
        .mobile-favorite-icon {
            display: none !important;
        }
    }
</style>
<!-- Модальное окно выбора города/региона -->
{% include 'partials/location_modal.html' %}
<script>
    let currentLocation = localStorage.getItem('userLocation') || 'Все регионы';
    let selectedCategoryId = "{{ request.args.get('category_id', '') }}";
    let searchTimeout = null;

    function selectCategory(categoryElement, categoryId) {
        // Убираем активный класс у всех категорий
        document.querySelectorAll('.main-category-item').forEach(item => {
            item.classList.remove('active');
        });

        // Добавляем активный класс выбранной категории
        categoryElement.classList.add('active');

        // Сохраняем выбранную категорию
        selectedCategoryId = categoryId;
        localStorage.setItem('selectedCategoryId', categoryId);

        // Обновляем селект выбора категории
        const categorySelect = document.getElementById('categoryFilter');
        if (categorySelect) {
            // Находим опцию с нужным значением или с текстом
            let found = false;
            for (let option of categorySelect.options) {
                if (option.value === categoryId || option.text === categoryElement.dataset.categoryName) {
                    option.selected = true;
                    found = true;
                    break;
                }
            }
            // Если не нашли точного соответствия, выбираем "Все категории"
            if (!found && categorySelect.options.length > 0) {
                categorySelect.options[0].selected = true;
            }
        }

        // Применяем фильтры
        const searchInput = document.getElementById('searchInput');
        const searchTerm = searchInput ? searchInput.value.trim() : '';
        applyFilters(categoryId, searchTerm);
    }

    function openLocationModal() {
        const modal = document.getElementById('locationModal');
        if (modal) {
            modal.style.display = 'block';
            const input = document.getElementById('locationInput');
            if (input) input.focus();
            loadPopularLocations();
        }
    }

    function closeLocationModal() {
        const modal = document.getElementById('locationModal');
        if (modal) modal.style.display = 'none';
    }

    function clearLocationInput() {
        const input = document.getElementById('locationInput');
        if (input) {
            input.value = '';
            input.focus();
            loadPopularLocations();
        }
    }

    function applyFilters(categoryId, searchTerm) {
        let url = new URL(window.location.href);
        if (categoryId) url.searchParams.set('category_id', categoryId);
        else url.searchParams.delete('category_id');

        if (searchTerm) url.searchParams.set('search', searchTerm);
        else url.searchParams.delete('search');

        if (currentLocation && currentLocation !== 'Все регионы') {
            url.searchParams.set('location', currentLocation);
        } else {
            url.searchParams.delete('location');
        }

        window.location.href = url.toString();
    }

    function loadPopularLocations() {
        const suggestions = document.getElementById('locationSuggestions');
        if (!suggestions) return;
        suggestions.innerHTML = '';

        // Popular locations to show when no search
        const locations = [
            { display_name: 'Москва' },
            { display_name: 'Санкт-Петербург' },
            { display_name: 'Казань' },
            { display_name: 'Екатеринбург' },
            { display_name: 'Новосибирск' },
            { display_name: 'Нижний Новгород' },
            { display_name: 'Краснодар' },
            { display_name: 'Челябинск' }
        ];

        try {
            // 1. Текущий выбранный город, если он есть и это не "Все регионы"

            if (currentLocation && currentLocation !== 'Все регионы') {
                const currentDiv = document.createElement('div');
                currentDiv.className = 'suggestion-item current-location';
                currentDiv.innerHTML = `<strong>${currentLocation}</strong> (текущий)`;
                currentDiv.onclick = function () {
                    closeLocationModal();
                };
                suggestions.appendChild(currentDiv);
            }
            // 2. "Все регионы" всегда на видном месте
            const allRegionsDiv = document.createElement('div');
            allRegionsDiv.className = 'suggestion-item all-regions';
            allRegionsDiv.innerHTML = 'Все регионы';
            allRegionsDiv.onclick = function () {
                setLocation('Все регионы');
            };
            suggestions.appendChild(allRegionsDiv);
            // 3. Разделитель
            const separator = document.createElement('div');
            separator.className = 'suggestion-separator';
            separator.innerHTML = 'Другие регионы и города';
            suggestions.appendChild(separator);
            // 4. Остальные локации из API
            for (let location of locations) {
                // Пропускаем "Все регионы" (уже добавили) и текущий город (уже добавили)
                if (location.display_name === 'Все регионы') continue;
                if (location.display_name === currentLocation) continue;
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.innerHTML = location.display_name;
                div.onclick = function () {
                    setLocation(location.display_name);
                };
                suggestions.appendChild(div);
            }
        } catch (error) {
            console.error('Ошибка загрузки локаций:', error);
            // Запасной статичный список
            suggestions.innerHTML = `
<div class="suggestion-item" onclick="setLocation('Все регионы')">
    Все регионы
</div>
<div class="suggestion-item" onclick="setLocation('Москва')">
    Москва
</div>
<div class="suggestion-item" onclick="setLocation('Санкт-Петербург')">
    Санкт-Петербург
</div>
<div class="suggestion-item" onclick="setLocation('Казань')">
    Казань
</div>
<div class="suggestion-item no-results">Ошибка загрузки данных</div>
`;
        }
    }

    // Функция поиска локаций через API
    async function searchLocations(searchTerm) {
        const suggestions = document.getElementById('locationSuggestions');
        if (!searchTerm || searchTerm.trim() === '') {
            // Если поле пустое, показываем популярные
            loadPopularLocations();
            return;
        }
        // Показываем индикатор загрузки
        suggestions.innerHTML = `
<div class="suggestion-item" onclick="setLocation('Все регионы')">
    Все регионы
</div>
<div class="loading-indicator">Поиск</div>
`;
        try {
            const response = await fetch(`/api/locations?search=${encodeURIComponent(searchTerm)}&limit=30`);
            const locations = await response.json();
            suggestions.innerHTML = '';
            // 1. Всегда показываем "Все регионы"
            const allRegionsDiv = document.createElement('div');
            allRegionsDiv.className = 'suggestion-item all-regions';
            allRegionsDiv.innerHTML = 'Все регионы';
            allRegionsDiv.onclick = function () {
                setLocation('Все регионы');
            };
            suggestions.appendChild(allRegionsDiv);
            // 2. Разделитель
            const separator = document.createElement('div');
            separator.className = 'suggestion-separator';
            separator.innerHTML = 'Результаты поиска';
            suggestions.appendChild(separator);
            // 3. Добавляем найденные локации
            let hasResults = false;
            for (let location of locations) {
                if (location.display_name === 'Все регионы') continue;
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.innerHTML = location.display_name;
                div.onclick = function () {
                    setLocation(location.display_name);
                };
                suggestions.appendChild(div);
                hasResults = true;
            }
            // 4. Если результатов нет (кроме "Все регионы")
            if (!hasResults) {
                suggestions.innerHTML += '<div class="suggestion-item no-results">Ничего не найдено</div>';
            }
        } catch (error) {
            console.error('Ошибка поиска локаций:', error);
            suggestions.innerHTML = `
<div class="suggestion-item" onclick="setLocation('Все регионы')">
    Все регионы
</div>
<div class="suggestion-item no-results">Ошибка поиска</div>
`;
        }
    }

    // Функция для задержки поиска (debounce)
    function debounceSearch() {
        const input = document.getElementById('locationInput');
        const searchTerm = input.value.trim();
        // Очищаем предыдущий таймаут
        if (searchTimeout) {
            clearTimeout(searchTimeout);
        }
        // Устанавливаем новый таймаут
        searchTimeout = setTimeout(() => {
            searchLocations(searchTerm);
        }, 300);
    }

    function setLocation(location) {
        currentLocation = location.trim();
        localStorage.setItem('userLocation', currentLocation);
        document.getElementById('locationText').textContent = currentLocation;
        closeLocationModal();
        // Применяем фильтры с новым местоположением
        const categorySelect = document.getElementById('categoryFilter');
        const searchInput = document.getElementById('searchInput');
        const categoryId = categorySelect ? categorySelect.value : '';
        const searchTerm = searchInput ? searchInput.value.trim() : '';
        applyFilters(categoryId, searchTerm);
    }

    // === ИНИЦИАЛИЗАЦИЯ ===
    document.addEventListener('DOMContentLoaded', function () {
        // Восстанавливаем выбранную категорию при загрузке
        if (selectedCategoryId) {
            const categoryElement = document.querySelector(`.main-category-item[data-category-id="${selectedCategoryId}"]`);
            if (categoryElement) {
                categoryElement.classList.add('active');
            } else {
                // Если не нашли по id, ищем по имени категории из localStorage
                const categoryName = localStorage.getItem('selectedCategoryName');
                if (categoryName) {
                    const categoryElementByName = document.querySelector(`.main-category-item[data-category-name="${categoryName}"]`);
                    if (categoryElementByName) {
                        categoryElementByName.classList.add('active');
                        selectedCategoryId = categoryElementByName.dataset.categoryId;
                    }
                }
            }
        } else {
            // Если категория не выбрана, активируем "Все категории"
            const allCategories = document.querySelector('.main-category-item[data-category-id=""]');
            if (allCategories) {
                allCategories.classList.add('active');
            }
        }

        // Сохраняем имя категории при клике
        document.querySelectorAll('.main-category-item').forEach(item => {
            item.addEventListener('click', function () {
                const categoryName = this.dataset.categoryName;
                if (categoryName) {
                    localStorage.setItem('selectedCategoryName', categoryName);
                }
            });
        });

        // Устанавливаем текущую локацию
        const locationText = document.getElementById('locationText');
        if (locationText) {
            locationText.textContent = currentLocation;
        }

        // Спрашиваем локацию при первом посещении
        const alreadyAsked = localStorage.getItem('locationAsked');
        if (!alreadyAsked) {
            setTimeout(() => {
                openLocationModal();
                localStorage.setItem('locationAsked', 'true');
            }, 1500);
        }

        // Обработчики для модального окна
        const locationDisplay = document.getElementById('locationDisplay');
        if (locationDisplay) {
            locationDisplay.addEventListener('click', openLocationModal);
        }

        const locationInput = document.getElementById('locationInput');
        if (locationInput) {
            locationInput.addEventListener('input', debounceSearch);
            locationInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    debounceSearch();
                }
            });
        }

        // Обработчики для фильтров
        const categorySelect = document.getElementById('categoryFilter');
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.querySelector('.search-btn');

        if (searchBtn) {
            searchBtn.addEventListener('click', function () {
                const categoryId = categorySelect ? categorySelect.value : '';
                const searchTerm = searchInput ? searchInput.value.trim() : '';
                applyFilters(categoryId, searchTerm);
            });
        }

        if (categorySelect) {
            categorySelect.addEventListener('change', function () {
                // При изменении селекта, обновляем активную категорию в блоке картинок
                const selectedValue = this.value;
                document.querySelectorAll('.main-category-item').forEach(item => {
                    item.classList.remove('active');
                });

                // Ищем соответствующий элемент категории
                let found = false;
                document.querySelectorAll('.main-category-item').forEach(item => {
                    if (item.dataset.categoryId === selectedValue) {
                        item.classList.add('active');
                        found = true;
                        selectedCategoryId = selectedValue;
                        localStorage.setItem('selectedCategoryId', selectedValue);
                    }
                });

                // Если не нашли, активируем "Все категории"
                if (!found) {
                    const allCategories = document.querySelector('.main-category-item[data-category-id=""]');
                    if (allCategories) {
                        allCategories.classList.add('active');
                        selectedCategoryId = '';
                        localStorage.setItem('selectedCategoryId', '');
                    }
                }

                const searchTerm = searchInput ? searchInput.value.trim() : '';
                applyFilters(selectedValue, searchTerm);
            });
        }

        if (searchInput) {
            searchInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    const categoryId = categorySelect ? categorySelect.value : '';
                    applyFilters(categoryId, this.value.trim());
                }
            });
        }

        // Закрытие модального окна при клике вне его
        window.addEventListener('click', function (event) {
            const modal = document.getElementById('locationModal');
            if (event.target === modal) {
                closeLocationModal();
            }
        });

        // Закрытие модального окна по ESC
        document.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') {
                closeLocationModal();
            }
        });

        // Переключение видов товаров
        const viewButtons = document.querySelectorAll('.view-btn');

        function activateView(viewType) {
            const containers = {
                grid: document.getElementById('productsGridView'),
                list: document.getElementById('productsListView'),
                table: document.getElementById('productsTableView')
            };

            // Показываем только выбранный вид, скрываем остальные
            for (let key in containers) {
                if (containers[key]) {
                    containers[key].style.display = key === viewType ? 'block' : 'none';
                }
            }

            // Обновляем активную кнопку
            viewButtons.forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-view') === viewType);
            });

            // Сохраняем выбор в localStorage
            localStorage.setItem('mainView', viewType);
        }

        viewButtons.forEach(button => {
            button.addEventListener('click', () => {
                const viewType = button.getAttribute('data-view');
                activateView(viewType);
            });
        });

        // Инициализация представления при загрузке
        const savedView = localStorage.getItem('mainView') || 'grid';
        activateView(savedView);





        // AJAX Favorite Toggle
        // AJAX Favorite Toggle
        window.toggleFavorite = function (event, productId, csrfToken) {
            event.preventDefault();
            event.stopPropagation();

            // Select ALL heart containers for this product (desktop, mobile, list view, etc.)
            const containers = document.querySelectorAll(`.favorite-icon-container[data-product-id="${productId}"]`);
            if (containers.length === 0) return;

            // Determine new state based on the first container found
            const firstContainer = containers[0];
            const currentlyFavorited = firstContainer.getAttribute('data-is-favorited') === 'true';
            const newState = !currentlyFavorited;

            // Optimistic update for ALL containers
            containers.forEach(container => {
                const filledHeart = container.querySelector('.heart-filled');
                const outlineHeart = container.querySelector('.heart-outline');

                if (newState) {
                    if (filledHeart) filledHeart.style.display = 'block';
                    if (outlineHeart) outlineHeart.style.display = 'none';
                    container.setAttribute('data-is-favorited', 'true');
                    // Also toggle active class on button if it exists
                    const btn = container.closest('.favorite-icon-btn');
                    if (btn) btn.classList.add('active');
                } else {
                    if (filledHeart) filledHeart.style.display = 'none';
                    if (outlineHeart) outlineHeart.style.display = 'block';
                    container.setAttribute('data-is-favorited', 'false');
                    const btn = container.closest('.favorite-icon-btn');
                    if (btn) btn.classList.remove('active');
                }
            });

            fetch(`/product/${productId}/favorite`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Network response form favorite toggle was not ok');
                })
                .then(data => {
                    if (data && data.success) {
                        // Ensure state matches server (verification)
                        const serverState = data.is_favorited;
                        containers.forEach(container => {
                            const filledHeart = container.querySelector('.heart-filled');
                            const outlineHeart = container.querySelector('.heart-outline');

                            if (serverState) {
                                if (filledHeart) filledHeart.style.display = 'block';
                                if (outlineHeart) outlineHeart.style.display = 'none';
                                container.setAttribute('data-is-favorited', 'true');
                            } else {
                                if (filledHeart) filledHeart.style.display = 'none';
                                if (outlineHeart) outlineHeart.style.display = 'block';
                                container.setAttribute('data-is-favorited', 'false');
                            }
                        });
                    }
                })
                .catch(error => {
                    console.error('Error toggling favorite:', error);
                    // Revert on error
                    containers.forEach(container => {
                        const filledHeart = container.querySelector('.heart-filled');
                        const outlineHeart = container.querySelector('.heart-outline');

                        if (currentlyFavorited) {
                            if (filledHeart) filledHeart.style.display = 'block';
                            if (outlineHeart) outlineHeart.style.display = 'none';
                            container.setAttribute('data-is-favorited', 'true');
                        } else {
                            if (filledHeart) filledHeart.style.display = 'none';
                            if (outlineHeart) outlineHeart.style.display = 'block';
                            container.setAttribute('data-is-favorited', 'false');
                        }
                    });
                });
        };

    });
</script>
{% endblock %}