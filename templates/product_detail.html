{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="product-details-container">
        <!-- –ë–∞–Ω–Ω–µ—Ä —Å—Ç–∞—Ç—É—Å–∞ -->
        {% if product.status != product.STATUS_PUBLISHED %}
        <div class="status-banner {% if product.status == product.STATUS_READY_FOR_PUBLICATION %}status-ready{% elif product.status == product.STATUS_UNPUBLISHED %}status-unpublished{% else %}status-review{% endif %}">
            {% if product.status == product.STATUS_READY_FOR_PUBLICATION %}
            ‚è∞ –°—Ä–æ–∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∏—Å—Ç–µ–∫. –¢–æ–≤–∞—Ä –≤–∏–¥–µ–Ω —Ç–æ–ª—å–∫–æ –≤–∞–º.
            {% elif product.status == product.STATUS_UNPUBLISHED %}
            üö´ –¢–æ–≤–∞—Ä —Å–Ω—è—Ç —Å –ø—É–±–ª–∏–∫–∞—Ü–∏–∏. –í–∏–¥–µ–Ω —Ç–æ–ª—å–∫–æ –≤–∞–º.
            {% else %}
            üîç –¢–æ–≤–∞—Ä –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ
            {% endif %}
        </div>
        {% endif %}
        
        <div class="product-layout">
            <!-- –ì–∞–ª–µ—Ä–µ—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
            <div class="product-gallery">
                {% if product.images and product.images|length > 0 %}
                    <div class="main-image">
                        <img src="/uploads/{{ product.images[0] }}" 
                             alt="{{ product.title }}" 
                             id="mainImage">
                    </div>
                    {% if product.images|length > 1 %}
                    <div class="image-thumbnails">
                        {% for image in product.images %}
                        <img src="/uploads/{{ image }}" 
                             alt="{{ product.title }}" 
                             class="thumbnail {% if loop.first %}active{% endif %}"
                             onclick="changeImage(this)">
                        {% endfor %}
                    </div>
                    {% endif %}
                {% else %}
                    <div class="main-image no-image">
                        <div class="no-image-placeholder">
                            <i>üì∑</i>
                            <span>–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</span>
                        </div>
                    </div>
                {% endif %}
            </div>
            
            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ -->
            <div class="product-info">
                <div class="product-details-header">
                    <h1 class="product-title">{{ product.title }}</h1>
                    <div class="product-price-large">{{ "%.2f"|format(product.price) }} ‚ÇΩ</div>
                </div>
                
                <div class="product-meta-info">
                    <div class="product-meta-item">
                        <span class="product-meta-label">–°—Ç–∞—Ç—É—Å:</span>
                        <span class="product-meta-value status-badge status-{{ product.status }}">
                            {{ product.status_text }}
                            {% if product.status == product.STATUS_PUBLISHED and product.days_remaining > 0 %}
                            (–æ—Å—Ç–∞–ª–æ—Å—å {{ product.days_remaining }} –¥–Ω.)
                            {% endif %}
                        </span>
                    </div>
                    <div class="product-meta-item">
                        <span class="product-meta-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</span>
                        <span class="product-meta-value">{{ product.category.name if product.category else '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏' }}</span>
                    </div>
                    <div class="product-meta-item">
                        <span class="product-meta-label">–î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:</span>
                        <span class="product-meta-value">{{ product.created_at.strftime('%d.%m.%Y') }}</span>
                    </div>
                    {% if product.status == product.STATUS_PUBLISHED %}
                    <div class="product-meta-item">
                        <span class="product-meta-label">–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ:</span>
                        <span class="product-meta-value">{{ product.expires_at.strftime('%d.%m.%Y') }}</span>
                    </div>
                    {% endif %}
                    <div class="product-meta-item">
                        <span class="product-meta-label">–ü—Ä–æ–¥–∞–≤–µ—Ü:</span>
                        <span class="product-meta-value">{{ product.user.username }}</span>
                    </div>
                </div>
                
                <div class="product-description-section">
                    <h3>–û–ø–∏—Å–∞–Ω–∏–µ</h3>
                    <div class="product-description-text">
                        {{ product.description or '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç' }}
                    </div>
                </div>
                
                {% if product.status == product.STATUS_PUBLISHED or current_user.id == product.user_id %}
                <div class="contact-section">
                    <h3>üìû –°–≤—è–∑–∞—Ç—å—Å—è —Å –ø—Ä–æ–¥–∞–≤—Ü–æ–º</h3>
                    <div class="contact-info">
                        <div class="contact-item">
                            <span class="contact-icon">üë§</span>
                            <span>{{ product.user.contact_person or product.user.company_name }}</span>
                        </div>
                        {% if product.user.phone %}
                        <div class="contact-item">
                            <span class="contact-icon">üì±</span>
                            <span>{{ product.user.phone }}</span>
                        </div>
                        {% endif %}
                        <div class="contact-item">
                            <span class="contact-icon">‚úâÔ∏è</span>
                            <span>{{ product.user.email }}</span>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {% if current_user.id == product.user_id or current_user.role == 'admin' %}
                <div class="product-actions">
                    {% if current_user.id == product.user_id %}
                    <a href="{{ url_for('main.edit_product', product_id=product.id) }}" 
                       class="btn-edit">
                        ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                    </a>
                    {% endif %}
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ —Å–Ω—è—Ç—å —Å –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ -->
                    {% if product.status == product.STATUS_PUBLISHED and current_user.id == product.user_id %}
                    <form action="{{ url_for('main.unpublish_product', product_id=product.id) }}" 
                          method="POST" 
                          style="display: inline;"
                          onsubmit="return confirm('–°–Ω—è—Ç—å —Ç–æ–≤–∞—Ä —Å –ø—É–±–ª–∏–∫–∞—Ü–∏–∏? –û–Ω —Å—Ç–∞–Ω–µ—Ç –≤–∏–¥–µ–Ω —Ç–æ–ª—å–∫–æ –≤–∞–º.')">
                        <button type="submit" class="btn-unpublish">
                            üö´ –°–Ω—è—Ç—å —Å –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
                        </button>
                    </form>
                    {% endif %}
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –¥–ª—è –∞—Ä—Ö–∏–≤–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ -->
                    {% if product.status == product.STATUS_READY_FOR_PUBLICATION and current_user.id == product.user_id %}
                    <form action="{{ url_for('main.renew_product', product_id=product.id) }}" 
                          method="POST" 
                          style="display: inline;">
                        <button type="submit" class="btn-publish">
                            üì¢ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å
                        </button>
                    </form>
                    {% endif %}
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –¥–ª—è —Å–Ω—è—Ç—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ -->
                    {% if product.status == product.STATUS_UNPUBLISHED and current_user.id == product.user_id %}
                    <form action="{{ url_for('main.renew_product', product_id=product.id) }}" 
                          method="POST" 
                          style="display: inline;">
                        <button type="submit" class="btn-publish">
                            üì¢ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å
                        </button>
                    </form>
                    {% endif %}
                    
                    <form action="{{ url_for('main.delete_product', product_id=product.id) }}" 
                          method="POST" 
                          style="display: inline;"
                          onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')">
                        <button type="submit" class="btn-delete">
                            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
.status-banner {
    padding: 12px 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    font-weight: 500;
    text-align: center;
}

.status-banner.status-ready {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    color: #856404;
}

.status-banner.status-unpublished {
    background: #ffebee;
    border: 1px solid #ffcdd2;
    color: #c62828;
}

.status-banner.status-review {
    background: #cce7ff;
    border: 1px solid #99ceff;
    color: #0066cc;
}

.status-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
}

.status-1 { background: #d4edda; color: #155724; }
.status-2 { background: #fff3cd; color: #856404; }
.status-3 { background: #f8d7da; color: #721c24; }
.status-4 { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }

.product-details-container {
    background: white;
    border-radius: 12px;
    padding: 32px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
}

.product-layout {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 32px;
    align-items: start;
}

.product-gallery {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.main-image {
    width: 100%;
    height: 400px;
    border-radius: 12px;
    overflow: hidden;
    background: var(--background-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--border);
}

.main-image img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    transition: transform 0.3s ease;
}

.main-image:hover img {
    transform: scale(1.02);
}

.image-thumbnails {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.thumbnail {
    width: 80px;
    height: 80px;
    border-radius: 8px;
    cursor: pointer;
    border: 2px solid transparent;
    object-fit: cover;
    transition: all 0.2s ease;
}

.thumbnail.active,
.thumbnail:hover {
    border-color: var(--avito-blue);
    transform: scale(1.05);
}

.no-image-placeholder {
    text-align: center;
    color: var(--text-secondary);
}

.no-image-placeholder i {
    font-size: 48px;
    display: block;
    margin-bottom: 8px;
}

.product-info {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.product-details-header {
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border-light);
}

.product-title {
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 12px;
    color: var(--text-primary);
    line-height: 1.2;
}

.product-price-large {
    font-size: 36px;
    font-weight: 700;
    color: var(--avito-blue);
}

.product-meta-info {
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding: 20px;
    background: var(--background-secondary);
    border-radius: var(--radius);
    border: 1px solid var(--border-light);
}

.product-meta-item {
    display: flex;
    align-items: center;
    gap: 8px;
    line-height: 1.4;
    padding: 4px 0;
}

.product-meta-label {
    font-weight: 600;
    color: var(--text-primary);
    min-width: 140px;
}

.product-meta-value {
    color: var(--text-secondary);
    flex: 1;
}

.product-description-section {
    padding: 24px;
    background: var(--background-secondary);
    border-radius: var(--radius);
    border: 1px solid var(--border-light);
}

.product-description-section h3 {
    color: var(--text-primary);
    margin-bottom: 16px;
    font-size: 20px;
    font-weight: 600;
}

.product-description-text {
    color: var(--text-secondary);
    line-height: 1.6;
    font-size: 15px;
    max-height: 200px;
    overflow-y: auto;
    padding-right: 8px;
}

.product-description-text::-webkit-scrollbar {
    width: 4px;
}

.product-description-text::-webkit-scrollbar-track {
    background: var(--border-light);
    border-radius: 2px;
}

.product-description-text::-webkit-scrollbar-thumb {
    background: var(--text-tertiary);
    border-radius: 2px;
}

.contact-section {
    padding: 24px;
    background: var(--avito-blue-light);
    border-radius: var(--radius);
    border: 1px solid var(--avito-blue);
}

.contact-section h3 {
    color: var(--avito-blue);
    margin-bottom: 16px;
    font-size: 20px;
    font-weight: 600;
}

.contact-info {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.contact-item {
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--text-primary);
}

.contact-icon {
    color: var(--avito-blue);
    font-weight: bold;
    min-width: 20px;
}

.product-actions {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
}

.btn-edit {
    background: linear-gradient(135deg, var(--avito-blue) 0%, var(--avito-blue-hover) 100%);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: var(--radius);
    text-decoration: none;
    font-weight: 500;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 87, 255, 0.3);
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    cursor: pointer;
}

.btn-edit:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0, 87, 255, 0.4);
    color: white;
    text-decoration: none;
}

.btn-unpublish {
    background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: var(--radius);
    text-decoration: none;
    font-weight: 500;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(255, 152, 0, 0.3);
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    cursor: pointer;
}

.btn-unpublish:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(255, 152, 0, 0.4);
    color: white;
}

.btn-publish {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: var(--radius);
    text-decoration: none;
    font-weight: 500;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    cursor: pointer;
}

.btn-publish:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(40, 167, 69, 0.4);
    color: white;
}

.btn-delete {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: var(--radius);
    text-decoration: none;
    font-weight: 500;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(245, 87, 108, 0.3);
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    cursor: pointer;
}

.btn-delete:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(245, 87, 108, 0.4);
    color: white;
    text-decoration: none;
}

@media (max-width: 768px) {
    .product-details-container {
        padding: 20px;
        margin: 0 16px;
    }
    
    .product-layout {
        grid-template-columns: 1fr;
        gap: 24px;
    }
    
    .product-title {
        font-size: 24px;
    }
    
    .product-price-large {
        font-size: 28px;
    }
    
    .main-image {
        height: 300px;
    }
    
    .product-meta-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
    }
    
    .product-meta-label {
        min-width: auto;
    }
    
    .product-actions {
        flex-direction: column;
    }
    
    .btn-edit,
    .btn-unpublish,
    .btn-publish,
    .btn-delete {
        width: 100%;
        justify-content: center;
        text-align: center;
    }
    
    .product-description-text {
        max-height: none;
        overflow-y: visible;
    }
}

@media (max-width: 480px) {
    .product-details-container {
        padding: 16px;
    }
    
    .product-title {
        font-size: 20px;
    }
    
    .product-price-large {
        font-size: 24px;
    }
    
    .main-image {
        height: 250px;
    }
    
    .thumbnail {
        width: 60px;
        height: 60px;
    }
}
</style>

<script>
function changeImage(thumb) {
    const mainImage = document.getElementById('mainImage');
    if (mainImage) {
        mainImage.src = thumb.src;
    }
    
    // Update active thumbnail
    document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
    thumb.classList.add('active');
}
</script>
{% endblock %}