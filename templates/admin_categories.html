{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="admin-header">
        <h1 class="page-title">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å</h1>
        <p class="admin-subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–æ–π –∏ –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º</p>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∏ ‚Äî –ù–ê–°–¢–û–Ø–©–ò–ï –°–°–´–õ–ö–ò -->
    <div class="admin-tabs mb-4">
        <div class="tabs">
            <a href="{{ url_for('admin_bp.admin_categories') }}" class="tab-btn active">üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏</a>
            <a href="{{ url_for('admin_bp.admin_users') }}" class="tab-btn">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
            <a href="#" class="tab-btn">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
        </div>
    </div>



    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç –≤ 2 –∫–æ–ª–æ–Ω–∫–∏ -->
    <div class="layout-container">
        <!-- –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê -->
        <div class="content-container">
            <!-- –ë–õ–û–ö: –ö–ê–¢–ï–ì–û–†–ò–ò -->
            <div class="category-block admin-section-block">
                <div class="block-header">
                    <div class="block-title">
                        <span class="block-icon">üìÇ</span>
                        <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤</h3>
                    </div>
                    <span class="block-badge">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</span>
                </div>



                <!-- –î–µ—Ä–µ–≤–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π -->
                <div class="admin-section">
                    <div class="section-header">
                        <h4>üå≥ –î–µ—Ä–µ–≤–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π</h4>
                        <span class="section-badge">–ü—Ä–æ—Å–º–æ—Ç—Ä</span>
                    </div>
                    <div class="section-card">
                        {% if categories %}
                        <div class="categories-tree" id="categoriesTree">
                            {% for parent in parent_categories %}
                            <div class="category-node" data-id="{{ parent.id }}" data-name="{{ parent.name|lower }}">
                                <div class="node-header">
                                    {% set children = categories|selectattr('parent_id', 'equalto', parent.id)|list %}
                                    {% if children %}
                                    <span class="toggle-icon" onclick="toggleCategory(this)">‚ûï</span>
                                    {% else %}
                                    <span class="toggle-icon">‚îú‚îÄ</span>
                                    {% endif %}

                                    <!-- –ò–∫–æ–Ω–∫–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º -->
                                    <span class="node-icon"
                                        onclick="showCategoryImage({{ parent.id }}, '{{ parent.name }}')"
                                        style="cursor: pointer; position: relative;"
                                        title="{% if parent.image %}–ü–æ–∫–∞–∑–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ{% else %}–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è{% endif %}">
                                        {% if parent.image %}
                                        <div class="category-image-thumbnail"
                                            style="width: 24px; height: 24px; border-radius: 4px; overflow: hidden; display: inline-flex; align-items: center; justify-content: center; background: #f5f5f5;">
                                            <img src="{{ url_for('main.get_category_image_by_size', category_id=parent.id, size='thumbnail') }}"
                                                alt="{{ parent.name }}"
                                                style="width: 100%; height: 100%; object-fit: cover;">
                                        </div>
                                        {% else %}
                                        üìÅ
                                        {% endif %}
                                    </span>

                                    <span class="node-name">{{ parent.name }}</span>
                                    {% if parent.description %}
                                    <span class="node-description text-muted">({{ parent.description }})</span>
                                    {% endif %}
                                    <span class="node-badge">{{ parent.products|length if parent.products else 0 }}
                                        —Ç–æ–≤.</span>
                                    <div class="node-actions">
                                        <button class="node-action-btn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
                                            onclick="editCategory({{ parent.id }}, '{{ parent.name }}', '{{ parent.description if parent.description else '' }}', {{ parent.parent_id or 'null' }}, {% if parent.image %}'{{ parent.image }}'{% else %}null{% endif %})"
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2">
                                            <path d="M11 4H4v7h7V4z"></path>
                                            <path
                                                d="M17.7 4L15.9 5.8 12.3 2.2 10.5 4l3.6 3.6 1.8-1.8 3.6 3.6 1.8-1.8L17.7 4z">
                                            </path>
                                            </svg>
                                        </button>

                                        <form method="POST" action="{{ url_for('admin_bp.admin_categories') }}"
                                            onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏ –≤—Å–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏?')"
                                            class="inline-form">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <input type="hidden" name="action" value="delete_category">
                                            <input type="hidden" name="category_id" value="{{ parent.id }}">
                                            <button type="submit" class="node-action-btn" title="–£–¥–∞–ª–∏—Ç—å">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                    stroke="currentColor" stroke-width="2">
                                                    <path d="M3 6h18v2H3V6z"></path>
                                                    <path
                                                        d="M8 6V4c0-1.1.9-2 2-2h4c1.1 0 2 .9 2 2v2M12 10v6m0 0l-2-2m2 2l2-2">
                                                    </path>
                                                </svg>
                                            </button>
                                        </form>
                                    </div>
                                </div>

                                {% if children %}
                                <div class="node-children" style="display: none;">
                                    {% for child in children %}
                                    <div class="category-node child-node" data-id="{{ child.id }}"
                                        data-name="{{ child.name|lower }}">
                                        <div class="node-header">
                                            <span class="toggle-icon">‚îî‚îÄ</span>
                                            <span class="node-icon"
                                                onclick="showCategoryImage({{ child.id }}, '{{ child.name }}')"
                                                style="cursor: pointer;"
                                                title="{% if child.image %}–ü–æ–∫–∞–∑–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ{% else %}–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è{% endif %}">
                                                {% if child.image %}
                                                <div class="category-image-thumbnail"
                                                    style="width: 20px; height: 20px; border-radius: 3px; overflow: hidden; display: inline-flex; align-items: center; justify-content: center; background: #f5f5f5;">
                                                    <img src="{{ url_for('main.get_category_image_by_size', category_id=child.id, size='thumbnail') }}"
                                                        alt="{{ child.name }}"
                                                        style="width: 100%; height: 100%; object-fit: cover;">
                                                </div>
                                                {% else %}
                                                üìÑ
                                                {% endif %}
                                            </span>
                                            <span class="node-name">{{ child.name }}</span>
                                            {% if child.description %}
                                            <span class="node-description text-muted">({{ child.description }})</span>
                                            {% endif %}
                                            <span class="node-badge">{{ child.products|length if child.products else 0
                                                }} —Ç–æ–≤.</span>
                                            <div class="node-actions">
                                                <button class="node-action-btn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
                                                    onclick="editCategory({{ parent.id }}, '{{ parent.name }}', '{{ parent.description if parent.description else '' }}', {{ parent.parent_id or 'null' }}, {% if parent.image %}'{{ parent.image }}'{% else %}null{% endif %})"
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                    stroke="currentColor" stroke-width="2">
                                                    <path d="M11 4H4v7h7V4z"></path>
                                                    <path
                                                        d="M17.7 4L15.9 5.8 12.3 2.2 10.5 4l3.6 3.6 1.8-1.8 3.6 3.6 1.8-1.8L17.7 4z">
                                                    </path>
                                                    </svg>
                                                </button>

                                                <form method="POST" action="{{ url_for('admin_bp.admin_categories') }}"
                                                    onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é?')"
                                                    class="inline-form">
                                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                    <input type="hidden" name="action" value="delete_category">
                                                    <input type="hidden" name="category_id" value="{{ child.id }}">
                                                    <button type="submit" class="node-action-btn" title="–£–¥–∞–ª–∏—Ç—å">
                                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                            stroke="currentColor" stroke-width="2">
                                                            <path d="M3 6h18v2H3V6z"></path>
                                                            <path
                                                                d="M8 6V4c0-1.1.9-2 2-2h4c1.1 0 2 .9 2 2v2M12 10v6m0 0l-2-2m2 2l2-2">
                                                            </path>
                                                        </svg>
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="empty-state">
                            <div class="empty-icon">üì≠</div>
                            <p>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- –î–æ–±–∞–≤–∏—Ç—å/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é -->
                <div class="admin-section compact-section">
                    <div class="section-header">
                        <h4 id="formTitle">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h4>
                        <span class="section-badge">–†—É—á–Ω–æ–µ</span>
                    </div>
                    <div class="section-card compact-card">
                        <form method="POST" action="{{ url_for('admin_bp.admin_categories') }}" class="category-form"
                            id="addCategoryForm" enctype="multipart/form-data">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="action" id="formAction" value="add_category">
                            <input type="hidden" name="category_id" id="editCategoryId" value="">

                            <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
                            <div class="mb-3" id="categoryImagePreview" style="display: none;">
                                <img id="categoryPreviewImg" src="" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä" class="img-thumbnail"
                                    style="max-height: 150px; max-width: 100%;">
                                <div class="form-check mt-2" id="removeImageCheckbox" style="display: none;">
                                    <input type="checkbox" class="form-check-input" name="remove_image"
                                        id="removeImage">
                                    <label class="form-check-label text-muted small" for="removeImage">–£–¥–∞–ª–∏—Ç—å
                                        –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <input type="text" name="name" id="categoryName"
                                        class="form-control form-control-sm" required placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ *">
                                </div>
                                <div class="form-group">
                                    <select name="parent_id" id="categoryParent" class="form-select form-select-sm">
                                        <option value="">-- –ë–µ–∑ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π --</option>
                                        {% for cat in categories %}
                                        <option value="{{ cat.id }}">{{ cat.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group col-md-6">
                                    <label class="form-label small">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:</label>
                                    <div class="file-input-wrapper">
                                        <input type="file" name="category_image" id="categoryImageInput"
                                            class="form-control form-control-sm" accept=".jpg,.jpeg,.png,.gif,.webp">
                                        <label for="categoryImageInput" class="file-input-label">
                                            <span class="file-input-text" id="categoryImageText">–í—ã–±–µ—Ä–∏—Ç–µ
                                                –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...</span>
                                            <span class="btn-secondary btn-sm">üñºÔ∏è</span>
                                        </label>
                                    </div>
                                    <small class="form-text text-muted">JPG, PNG, WebP. –ú–∞–∫—Å: 5MB</small>
                                </div>

                                <div class="form-group col-md-6">
                                    <label class="form-label small">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                                    <textarea name="description" id="categoryDescription"
                                        class="form-control form-control-sm" rows="1" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"
                                        style="height: 48px;"></textarea>
                                </div>
                            </div>

                            <div class="form-actions compact-actions mt-3">
                                <button type="submit" class="btn-primary btn-sm" id="categorySubmitBtn">‚ûï
                                    –î–æ–±–∞–≤–∏—Ç—å</button>
                                <button type="reset" class="btn-secondary btn-sm"
                                    onclick="resetCategoryForm()">–û—á–∏—Å—Ç–∏—Ç—å</button>
                                <button type="button" class="btn-warning btn-sm" id="categoryCancelBtn"
                                    style="display: none;" onclick="resetCategoryForm()">–û—Ç–º–µ–Ω–∞</button>
                            </div>
                        </form>

                        <hr class="my-4">

                        <!-- –ò–º–ø–æ—Ä—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π (–≤ —Ç–æ–º –∂–µ –±–ª–æ–∫–µ) -->
                        <div class="import-section">
                            <h5 class="mb-3 text-muted" style="font-size: 14px;">üì§ –ò–º–ø–æ—Ä—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π (JSON)</h5>
                            <form method="POST" action="{{ url_for('admin_bp.upload_categories') }}"
                                enctype="multipart/form-data" class="upload-form">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <div class="input-group input-group-sm">
                                    <input type="file" name="categories_file" accept=".json" class="form-control"
                                        required id="jsonFile">
                                    <button type="submit" class="btn btn-outline-primary">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ë–õ–û–ö: –†–ï–ì–ò–û–ù–´ –ò –ì–û–†–û–î–ê -->
            <div class="locations-block admin-section-block">
                <div class="block-header">
                    <div class="block-title">
                        <span class="block-icon">üåç</span>
                        <h3>–†–µ–≥–∏–æ–Ω—ã –∏ –≥–æ—Ä–æ–¥–∞</h3>
                    </div>
                    <span class="block-badge">–ì–µ–æ–≥—Ä–∞—Ñ–∏—è</span>
                </div>

                <!-- –î–µ—Ä–µ–≤–æ —Ä–µ–≥–∏–æ–Ω–æ–≤ -->
                <div class="admin-section">
                    <div class="section-header">
                        <h4>üìç –î–µ—Ä–µ–≤–æ —Ä–µ–≥–∏–æ–Ω–æ–≤ –∏ –≥–æ—Ä–æ–¥–æ–≤</h4>
                        <span class="section-badge">–ü—Ä–æ—Å–º–æ—Ç—Ä</span>
                    </div>
                    <div class="section-card">
                        {% if regions and regions|length > 0 %}
                        <div class="categories-tree" id="regionsTree">
                            {% for region in regions %}
                            <div class="category-node" data-name="{{ region.name|lower }}">
                                <div class="node-header">
                                    {% set region_cities = [] %}
                                    {% for city in cities %}
                                    {% if city.region_id == region.id %}
                                    {% set _ = region_cities.append(city) %}
                                    {% endif %}
                                    {% endfor %}
                                    {% if region_cities %}
                                    <span class="toggle-icon" onclick="toggleCategory(this)">‚ûï</span>
                                    {% else %}
                                    <span class="toggle-icon">‚îú‚îÄ</span>
                                    {% endif %}
                                    <span class="node-icon">üìç</span>
                                    <span class="node-name">{{ region.name }}</span>
                                    <span class="node-badge">{{ region_cities|length }} –≥–æ—Ä.</span>
                                    <div class="node-actions">
                                        <button class="node-action-btn" title="–î–æ–±–∞–≤–∏—Ç—å –≥–æ—Ä–æ–¥"
                                            onclick="showAddCityForm({{ region.id }}, '{{ region.name }}')">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                stroke="currentColor" stroke-width="2">
                                                <path d="M12 5v14m-7-7h14"></path>
                                            </svg>
                                        </button>
                                        <form method="POST"
                                            action="{{ url_for('admin_bp.delete_region', region_id=region.id) }}"
                                            onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —Ä–µ–≥–∏–æ–Ω –∏ –≤—Å–µ –≥–æ—Ä–æ–¥–∞?')">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <button type="submit" class="node-action-btn" title="–£–¥–∞–ª–∏—Ç—å">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                    stroke="currentColor" stroke-width="2">
                                                    <path d="M3 6h18v2H3V6z"></path>
                                                    <path
                                                        d="M8 6V4c0-1.1.9-2 2-2h4c1.1 0 2 .9 2 2v2M12 10v6m0 0l-2-2m2 2l2-2">
                                                    </path>
                                                </svg>
                                            </button>
                                        </form>
                                    </div>
                                </div>

                                {% if region_cities %}
                                <div class="node-children" style="display: none;">
                                    {% for city in region_cities %}
                                    <div class="category-node child-node" data-name="{{ city.name|lower }}">
                                        <div class="node-header">
                                            <span class="toggle-icon">‚îî‚îÄ</span>
                                            <span class="node-icon">üèôÔ∏è</span>
                                            <span class="node-name">{{ city.name }}</span>
                                            <div class="node-actions">
                                                <form method="POST"
                                                    action="{{ url_for('admin_bp.delete_city', city_id=city.id) }}"
                                                    onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –≥–æ—Ä–æ–¥?')">
                                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                    <button type="submit" class="node-action-btn" title="–£–¥–∞–ª–∏—Ç—å">
                                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                            stroke="currentColor" stroke-width="2">
                                                            <path d="M3 6h18v2H3V6z"></path>
                                                            <path
                                                                d="M8 6V4c0-1.1.9-2 2-2h4c1.1 0 2 .9 2 2v2M12 10v6m0 0l-2-2m2 2l2-2">
                                                            </path>
                                                        </svg>
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="empty-state">
                            <div class="empty-icon">üåç</div>
                            <p>–†–µ–≥–∏–æ–Ω—ã –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</p>
                            <small style="color: #666;">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º—É –Ω–∏–∂–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è</small>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–≥–∏–æ–Ω/–≥–æ—Ä–æ–¥ -->
                <div class="admin-section compact-section">
                    <div class="section-header">
                        <h4>‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–≥–∏–æ–Ω/–≥–æ—Ä–æ–¥</h4>
                        <span class="section-badge">–†—É—á–Ω–æ–µ</span>
                    </div>
                    <div class="section-card compact-card">
                        <form method="POST" action="{{ url_for('admin_bp.add_region') }}" class="category-form"
                            id="addLocationForm">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="location_type" id="locationType" value="region">

                            <div class="form-group mb-2">
                                <select name="location_type_select" id="locationTypeSelect"
                                    class="form-select form-select-sm" onchange="changeLocationType(this.value)">
                                    <option value="region">–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–≥–∏–æ–Ω</option>
                                    <option value="city">–î–æ–±–∞–≤–∏—Ç—å –≥–æ—Ä–æ–¥</option>
                                </select>
                            </div>

                            <div class="form-group mb-2" id="regionSelectGroup">
                                <select name="parent_id" id="parentRegionSelect" class="form-select form-select-sm">
                                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω --</option>
                                    {% for region in regions %}
                                    <option value="{{ region.id }}">{{ region.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="form-row">
                                <div class="form-group col-md-6 mb-2">
                                    <input type="text" name="name" id="locationName"
                                        class="form-control form-control-sm" required placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ *">
                                </div>

                                <div class="form-group col-md-6 mb-2">
                                    <textarea name="description" id="locationDescription"
                                        class="form-control form-control-sm" rows="1" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"
                                        style="height: 31px;"></textarea>
                                </div>
                            </div>

                            <div class="form-actions compact-actions">
                                <button type="submit" class="btn-primary btn-sm" id="locationSubmitBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å
                                    —Ä–µ–≥–∏–æ–Ω</button>
                                <button type="reset" class="btn-secondary btn-sm">–û—á–∏—Å—Ç–∏—Ç—å</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–≥–∏–æ–Ω–æ–≤ –∏ –≥–æ—Ä–æ–¥–æ–≤ -->
                <div class="admin-section compact-section">
                    <div class="section-header">
                        <h4>üì• –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–≥–∏–æ–Ω–æ–≤ –∏ –≥–æ—Ä–æ–¥–æ–≤</h4>
                        <span class="section-badge">–ú–∞—Å—Å–æ–≤—ã–π –∏–º–ø–æ—Ä—Ç</span>
                    </div>
                    <div class="section-card compact-card">
                        <form method="POST" action="{{ url_for('admin_bp.upload_locations') }}"
                            enctype="multipart/form-data" class="upload-form">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                            <div class="mb-2">
                                <label class="form-label">–§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞:</label>
                                <select name="file_type" class="form-select form-select-sm" required>
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç...</option>
                                    <option value="csv">CSV (—Ä–µ–≥–∏–æ–Ω—ã –∏ –≥–æ—Ä–æ–¥–∞)</option>
                                    <option value="json">JSON (—Ä–µ–≥–∏–æ–Ω—ã –∏ –≥–æ—Ä–æ–¥–∞)</option>
                                </select>
                            </div>

                            <div class="file-input-wrapper mb-2">
                                <input type="file" name="locations_file" accept=".csv,.json,.txt"
                                    class="form-control form-control-sm" required id="locationsFile">
                                <label for="locationsFile" class="file-input-label">
                                    <span class="file-input-text">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª...</span>
                                    <span class="btn-secondary btn-sm">üìÅ</span>
                                </label>
                            </div>

                            <div class="mb-3">
                                <small class="text-muted d-block">–§–æ—Ä–º–∞—Ç CSV: <code>—Ä–µ–≥–∏–æ–Ω;–≥–æ—Ä–æ–¥</code> –∏–ª–∏
                                    <code>—Ä–µ–≥–∏–æ–Ω,–≥–æ—Ä–æ–¥</code></small>
                                <small class="text-muted d-block">–§–æ—Ä–º–∞—Ç JSON:
                                    <code>{"regions": [{"name": "–†–µ–≥–∏–æ–Ω", "cities": ["–ì–æ—Ä–æ–¥1", "–ì–æ—Ä–æ–¥2"]}]}</code>
                                    –∏–ª–∏
                                    <code>[{"region": "–†–µ–≥–∏–æ–Ω", "city": "–ì–æ—Ä–æ–¥"}]</code>
                                </small>
                            </div>

                            <div class="form-check mb-3">
                                <input type="checkbox" name="clear_existing" id="clearExisting"
                                    class="form-check-input">
                                <label for="clearExisting" class="form-check-label">–£–¥–∞–ª–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ</label>
                            </div>

                            <button type="submit" class="btn-primary btn-sm">üåç –ó–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–∫–∞—Ü–∏–∏</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê (sidebar) -->
        <div class="sidebar-container">
            <div class="sidebar">
                <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
                <div class="sidebar-section">
                    <h4 class="sidebar-title">‚ö° –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h4>
                    <div class="quick-actions">
                        <button class="quick-action" onclick="testLocationsAPI()">
                            <span class="action-icon">üîç</span>
                            <span class="action-text">–¢–µ—Å—Ç API –ª–æ–∫–∞—Ü–∏–π</span>
                        </button>
                        <button class="quick-action" onclick="showTemplate()">
                            <span class="action-icon">üìã</span>
                            <span class="action-text">–®–∞–±–ª–æ–Ω CSV</span>
                        </button>

                        <button class="quick-action" onclick="clearAllCategoryImages()">
                            <span class="action-icon">üóëÔ∏è</span>
                            <span class="action-text">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Ñ–æ—Ç–æ</span>
                        </button>
                    </div>
                </div>

                <!-- –û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞ -->
                <div class="sidebar-section danger-zone">
                    <h4 class="sidebar-title">‚ö†Ô∏è –û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞</h4>
                    <div class="danger-actions">
                        <form method="POST" action="{{ url_for('admin_bp.clear_categories') }}"
                            onsubmit="return confirmDanger('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã!')">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn-danger btn-full">
                                <span class="btn-icon">üóëÔ∏è</span>
                                –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                            </button>
                        </form>

                        <form method="POST" action="{{ url_for('admin_bp.admin_categories') }}"
                            onsubmit="return confirmDanger('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –ø—É—Å—Ç—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –±–µ–∑ —Ç–æ–≤–∞—Ä–æ–≤?')">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="action" value="clear_empty">
                            <button type="submit" class="btn-warning btn-full">
                                <span class="btn-icon">üßπ</span>
                                –û—á–∏—Å—Ç–∏—Ç—å –ø—É—Å—Ç—ã–µ
                            </button>
                        </form>

                        <form method="POST" action="{{ url_for('admin_bp.admin_categories') }}"
                            onsubmit="return confirmDanger('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π? –¢–æ–≤–∞—Ä—ã –æ—Å—Ç–∞–Ω—É—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.')">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="action" value="clear_images">
                            <button type="submit" class="btn-warning btn-full">
                                <span class="btn-icon">üñºÔ∏è</span>
                                –û—á–∏—Å—Ç–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                            </button>
                        </form>

                    </div>
                </div>

                <!-- –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã -->
                <div class="sidebar-section">
                    <h4 class="sidebar-title">üìà –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</h4>
                    <div class="system-status">
                        <div class="status-item">
                            <span class="status-label">–ö–∞—Ç–µ–≥–æ—Ä–∏–π:</span>
                            <span class="status-value">{{ categories|length }}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">–° —Ñ–æ—Ç–æ:</span>
                            <span class="status-value">{{ categories_with_images|length if categories_with_images else 0
                                }}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">–†–µ–≥–∏–æ–Ω–æ–≤:</span>
                            <span class="status-value">{{ all_regions|length if all_regions else 0 }}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">–ì–æ—Ä–æ–¥–æ–≤:</span>
                            <span class="status-value">{{ cities_count if cities_count else 0 }}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">–¢–æ–≤–∞—Ä–æ–≤:</span>
                            <span class="status-value">{{ total_products or 0 }}</span>
                        </div>
                    </div>
                </div>

                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–æ—Ä–º–∞—Ç–∞—Ö -->
                <div class="sidebar-section">
                    <h4 class="sidebar-title">‚ÑπÔ∏è –§–æ—Ä–º–∞—Ç—ã —Ñ–∞–π–ª–æ–≤</h4>
                    <div class="format-info">
                        <div class="format-item">
                            <strong>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:</strong> JPG, PNG, GIF, WebP
                        </div>
                        <div class="format-item">
                            <strong>–ú–∞–∫—Å. —Ä–∞–∑–º–µ—Ä:</strong> 5MB
                        </div>
                        <div class="format-item">
                            <strong>–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ä–∞–∑–º–µ—Ä:</strong> 300√ó300px
                        </div>
                        <div class="format-item">
                            <strong>CSV –¥–ª—è –ª–æ–∫–∞—Ü–∏–π:</strong><br>
                            <code>—Ä–µ–≥–∏–æ–Ω;–≥–æ—Ä–æ–¥</code>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —à–∞–±–ª–æ–Ω–∞ -->
<div class="modal fade" id="templateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–®–∞–±–ª–æ–Ω CSV —Ñ–∞–π–ª–∞</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre id="csvTemplate">—Ä–µ–≥–∏–æ–Ω;–≥–æ—Ä–æ–¥
–ú–æ—Å–∫–≤–∞;–ú–æ—Å–∫–≤–∞
–ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å;–•–∏–º–∫–∏
–ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å;–ü–æ–¥–æ–ª—å—Å–∫
–ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å;–ö–æ—Ä–æ–ª—ë–≤
–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥;–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥
–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å;–ì–∞—Ç—á–∏–Ω–∞
–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å;–í—ã–±–æ—Ä–≥
–†–µ—Å–ø—É–±–ª–∏–∫–∞ –¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω;–ö–∞–∑–∞–Ω—å
–†–µ—Å–ø—É–±–ª–∏–∫–∞ –¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω;–ù–∞–±–µ—Ä–µ–∂–Ω—ã–µ –ß–µ–ª–Ω—ã
–†–µ—Å–ø—É–±–ª–∏–∫–∞ –¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω;–ê–ª—å–º–µ—Ç—å–µ–≤—Å–∫
–°–≤–µ—Ä–¥–ª–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å;–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥
–°–≤–µ—Ä–¥–ª–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å;–ù–∏–∂–Ω–∏–π –¢–∞–≥–∏–ª
–°–≤–µ—Ä–¥–ª–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å;–ö–∞–º–µ–Ω—Å–∫-–£—Ä–∞–ª—å—Å–∫–∏–π</pre>
                <div class="mt-3">
                    <button class="btn btn-sm btn-secondary" onclick="copyTemplate()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                    <a href="#" class="btn btn-sm btn-primary" id="downloadTemplate">–°–∫–∞—á–∞—Ç—å CSV</a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –±–ª–æ–∫–æ–≤ */
    .admin-section-block {
        background: var(--background);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        margin-bottom: 24px;
        overflow: hidden;
        box-shadow: var(--shadow);
    }

    .category-block {
        border-top: 4px solid #3498db;
    }

    .locations-block {
        border-top: 4px solid #2ecc71;
    }

    .block-header {
        background: var(--background-secondary);
        padding: 16px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--border);
    }

    .block-title {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .block-icon {
        font-size: 24px;
    }

    .block-title h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
    }

    .block-badge {
        background: var(--avito-blue);
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
    }

    .locations-block .block-badge {
        background: #2ecc71;
    }

    /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ä–º */
    .compact-section {
        margin-bottom: 16px;
    }

    .compact-card {
        padding: 16px;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border);
    }

    .section-header h4 {
        margin: 0;
        font-size: 15px;
        font-weight: 600;
        color: var(--text-primary);
    }

    .section-badge {
        background: var(--background);
        color: var(--text-secondary);
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
        border: 1px solid var(--border);
    }

    .section-card {
        background: var(--background-secondary);
        border-radius: var(--radius);
        padding: 20px;
        border: 1px solid var(--border);
    }

    /* –°—Ç–∏–ª–∏ –¥–µ—Ä–µ–≤–∞ */
    .categories-tree {
        background: var(--background-secondary);
        border-radius: var(--radius);
        padding: 8px;
        max-height: 350px;
        overflow-y: auto;
        border: 1px solid var(--border);
        font-size: 13px;
    }

    .category-node {
        margin-bottom: 2px;
        padding-left: 4px;
        line-height: 1.3;
    }

    .category-node.child-node {
        padding-left: 20px;
        margin-top: 1px;
    }

    .node-header {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 4px 8px;
        font-size: 13px;
        border-radius: 4px;
        min-height: 28px;
        transition: background 0.2s;
    }

    .node-header:hover {
        background: rgba(0, 0, 0, 0.04);
    }

    .toggle-icon {
        font-size: 10px;
        cursor: pointer;
        min-width: 16px;
        text-align: center;
        color: var(--text-tertiary);
        user-select: none;
    }

    .node-icon {
        font-size: 12px;
        opacity: 0.8;
        min-width: 16px;
        text-align: center;
    }

    .node-name {
        color: var(--text-primary);
        font-weight: 500;
        flex: 1;
        font-size: 13px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .node-description {
        font-size: 11px;
        color: var(--text-tertiary);
        margin-left: 6px;
        font-style: italic;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 150px;
    }

    .node-badge {
        background: var(--avito-blue-light);
        color: var(--avito-blue);
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 10px;
        font-weight: 600;
        min-width: 40px;
        text-align: center;
    }

    .node-actions {
        display: flex;
        gap: 2px;
        opacity: 0.7;
        margin-left: auto;
    }

    .node-header:hover .node-actions {
        opacity: 1;
    }

    .node-action-btn {
        background: transparent;
        border: 1px solid var(--border);
        padding: 3px 6px;
        border-radius: 3px;
        color: var(--text-secondary);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        min-width: 24px;
        min-height: 24px;
    }

    .node-action-btn:hover {
        background: var(--avito-blue-light);
        color: var(--avito-blue);
        border-color: var(--avito-blue);
        transform: scale(1.05);
    }

    .node-action-btn svg {
        width: 12px;
        height: 12px;
    }

    .node-children {
        padding-left: 20px;
        margin-top: 2px;
        margin-bottom: 2px;
        border-left: 1px dashed var(--border);
        margin-left: 8px;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –º–∏–Ω–∏–∞—Ç—é—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∫–∞—Ç–µ–≥–æ—Ä–∏–π */
    .category-image-thumbnail {
        transition: transform 0.2s, box-shadow 0.2s;
        border: 1px solid var(--border);
    }

    .category-image-thumbnail:hover {
        transform: scale(1.1);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    /* –§–æ—Ä–º—ã */
    .form-control-sm,
    .form-select-sm {
        padding: 8px 12px;
        font-size: 14px;
        border-radius: var(--radius);
    }

    .btn-sm {
        padding: 8px 16px;
        font-size: 14px;
        border-radius: var(--radius);
    }

    .compact-actions {
        display: flex;
        gap: 8px;
        margin-top: 12px;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 12px;
    }

    @media (max-width: 768px) {
        .form-row {
            grid-template-columns: 1fr;
        }
    }

    /* –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ */
    .file-input-wrapper {
        position: relative;
        margin-bottom: 12px;
    }

    .file-input-wrapper input[type="file"] {
        position: absolute;
        width: 1px;
        height: 1px;
        opacity: 0;
    }

    .file-input-label {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 12px;
        background: var(--background);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
    }

    .file-input-label:hover {
        border-color: var(--avito-blue);
        background: var(--avito-blue-light);
    }

    .file-input-text {
        color: var(--text-secondary);
    }

    .file-input-label:hover .file-input-text {
        margin-left: 24px;
        padding-left: 12px;
        border-left: 1px dashed var(--border-color);
    }

    /* Sidebar Actions */
    .sidebar-section {
        background: var(--card-bg);
        border-radius: var(--radius);
        padding: 16px;
        border: 1px solid var(--border-color);
        margin-bottom: 16px;
    }

    .sidebar-section h4 {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 12px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .quick-actions-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 8px;
    }

    .quick-action {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px;
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        text-decoration: none;
        color: var(--text-main);
        transition: all 0.2s;
        font-size: 14px;
    }

    .quick-action:hover {
        border-color: var(--primary);
        background: #eff6ff;
        color: var(--primary);
        transform: translateX(2px);
    }

    .danger-zone {
        border-color: #fecaca;
        background: #fef2f2;
    }

    .danger-zone h4 {
        color: #dc2626;
    }

    .btn-danger-outline {
        width: 100%;
        padding: 8px;
        background: white;
        border: 1px solid #fecaca;
        color: #dc2626;
        border-radius: 6px;
        font-size: 13px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.2s;
    }

    .btn-danger-outline:hover {
        background: #dc2626;
        color: white;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 40px;
        color: var(--text-muted);
    }

    .empty-icon {
        font-size: 40px;
        margin-bottom: 16px;
        opacity: 0.5;
    }

    /* File Input */
    .file-input-wrapper {
        position: relative;
        overflow: hidden;
    }

    .file-input-label {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 12px;
        background: white;
        border: 1px dashed var(--border-color);
        border-radius: var(--radius);
        cursor: pointer;
    }

    .file-input-label:hover {
        border-color: var(--primary);
        background: #f8fafc;
    }

    .hidden {
        display: none !important;
    }
</style>

<script>
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∏–ø–∞ –ª–æ–∫–∞—Ü–∏–∏
    function changeLocationType(type) {
        const locationType = document.getElementById('locationType');
        const regionSelectGroup = document.getElementById('regionSelectGroup');
        const submitBtn = document.getElementById('locationSubmitBtn');

        locationType.value = type;

        if (type === 'city') {
            regionSelectGroup.style.display = 'block';
            submitBtn.textContent = '‚ûï –î–æ–±–∞–≤–∏—Ç—å –≥–æ—Ä–æ–¥';
            document.getElementById('parentRegionSelect').required = true;
        } else {
            regionSelectGroup.style.display = 'none';
            submitBtn.textContent = '‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–≥–∏–æ–Ω';
            document.getElementById('parentRegionSelect').required = false;
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    function editCategory(id, name, description, parentId, image) {
        document.getElementById('editCategoryId').value = id;
        document.getElementById('categoryName').value = name;
        document.getElementById('categoryDescription').value = description || '';
        document.getElementById('categoryParent').value = parentId || '';

        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ñ–æ—Ä–º—ã
        document.getElementById('formTitle').textContent = '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é';

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        const previewDiv = document.getElementById('categoryImagePreview');
        const previewImg = document.getElementById('categoryPreviewImg');
        const removeCheckbox = document.getElementById('removeImageCheckbox');

        if (image && image !== 'null') {
            previewImg.src = `/uploads/${image}`;
            previewDiv.style.display = 'block';
            removeCheckbox.style.display = 'block';
        } else {
            previewDiv.style.display = 'none';
            removeCheckbox.style.display = 'none';
        }

        // –ú–µ–Ω—è–µ–º —Ñ–æ—Ä–º—É –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
        document.getElementById('categorySubmitBtn').textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        document.getElementById('categoryCancelBtn').style.display = 'inline-block';

        // –ú–µ–Ω—è–µ–º action —Ñ–æ—Ä–º—ã
        document.getElementById('formAction').value = 'edit_category';

        // –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –∫ —Ñ–æ—Ä–º–µ
        document.getElementById('addCategoryForm').scrollIntoView({ behavior: 'smooth' });
    }

    // –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ —Ñ–æ—Ä–º—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    function resetCategoryForm() {
        document.getElementById('editCategoryId').value = '';
        document.getElementById('categorySubmitBtn').textContent = '‚ûï –î–æ–±–∞–≤–∏—Ç—å';
        document.getElementById('categoryCancelBtn').style.display = 'none';
        document.getElementById('formTitle').textContent = '‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é';

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        const previewDiv = document.getElementById('categoryImagePreview');
        const previewImg = document.getElementById('categoryPreviewImg');
        const removeCheckbox = document.getElementById('removeImageCheckbox');
        previewDiv.style.display = 'none';
        removeCheckbox.style.display = 'none';
        previewImg.src = '';

        // –£–±–∏—Ä–∞–µ–º —á–µ–∫–±–æ–∫—Å —É–¥–∞–ª–µ–Ω–∏—è
        if (document.getElementById('removeImage')) {
            document.getElementById('removeImage').checked = false;
        }

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
        document.getElementById('addCategoryForm').reset();

        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º action –Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ
        document.getElementById('formAction').value = 'add_category';

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç —Ñ–∞–π–ª–æ–≤–æ–≥–æ –∏–Ω–ø—É—Ç–∞
        const imageText = document.getElementById('categoryImageText');
        if (imageText) {
            imageText.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...';
            imageText.style.color = '';
        }
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≥–æ—Ä–æ–¥–∞
    function showAddCityForm(regionId, regionName) {
        const locationTypeSelect = document.getElementById('locationTypeSelect');
        const parentRegionSelect = document.getElementById('parentRegionSelect');

        locationTypeSelect.value = 'city';
        parentRegionSelect.value = regionId;

        changeLocationType('city');

        // –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –∫ —Ñ–æ—Ä–º–µ
        document.getElementById('addLocationForm').scrollIntoView({ behavior: 'smooth' });

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        alert(`–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ –≤ —Ä–µ–≥–∏–æ–Ω: ${regionName}`);
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    function showCategoryImage(categoryId, categoryName) {
        // –ò—â–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é –≤ DOM
        const categoryNode = document.querySelector(`.category-node[data-id="${categoryId}"]`);
        if (!categoryNode) return;

        const imageThumb = categoryNode.querySelector('.category-image-thumbnail img');
        if (!imageThumb || !imageThumb.src || imageThumb.src.includes('data:')) {
            alert(`–£ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "${categoryName}" –Ω–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è`);
            return;
        }

        // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å URL –±–æ–ª—å—à–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        let fullImageSrc = imageThumb.src;
        if (fullImageSrc.includes('size=thumbnail')) {
            fullImageSrc = fullImageSrc.replace('size=thumbnail', 'size=original');
        } else if (fullImageSrc.includes('_thumbnail')) {
            fullImageSrc = fullImageSrc.replace('_thumbnail', '');
        }

        // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
        const modalId = 'categoryImageModal_' + categoryId;

        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –º–æ–¥–∞–ª–∫—É –µ—Å–ª–∏ –µ—Å—Ç—å
        const oldModal = document.getElementById(modalId);
        if (oldModal) {
            const instance = bootstrap.Modal.getInstance(oldModal);
            if (instance) instance.dispose();
            oldModal.remove();
        }

        const modalHtml = `
        <div class="modal fade image-modal" id="${modalId}" tabindex="-1" aria-labelledby="modalLabel_${categoryId}" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content" style="background: transparent; border: none; box-shadow: none;">
                    <div class="position-absolute top-0 end-0 m-3" style="z-index: 1070;">
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" style="background-color: white; opacity: 0.8; padding: 10px; border-radius: 50%;"></button>
                    </div>
                    <div class="modal-body text-center p-0">
                        <img src="${fullImageSrc}" alt="${categoryName}" class="img-fluid" 
                             style="max-height: 85vh; border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); object-fit: contain;">
                        <div class="mt-2 text-white fw-bold text-shadow" style="text-shadow: 0 2px 4px rgba(0,0,0,0.8);">${categoryName}</div>
                    </div>
                </div>
            </div>
        </div>
        `;

        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –º–æ–¥–∞–ª–∫—É –≤ –∫–æ–Ω–µ—Ü body
        document.body.insertAdjacentHTML('beforeend', modalHtml);

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
        const modalElement = document.getElementById(modalId);
        const modal = new bootstrap.Modal(modalElement, {
            backdrop: true,
            keyboard: true
        });

        modal.show();

        // –û—á–∏—Å—Ç–∫–∞ –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è
        modalElement.addEventListener('hidden.bs.modal', function () {
            modal.dispose();
            modalElement.remove();
        });
    }

    // –ü–æ–∏—Å–∫ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    document.getElementById('categorySearch')?.addEventListener('input', function () {
        const searchTerm = this.value.toLowerCase().trim();
        const allItems = document.querySelectorAll('.category-node');

        if (!searchTerm) {
            allItems.forEach(item => item.classList.remove('hidden'));
            return;
        }

        allItems.forEach(item => {
            item.classList.add('hidden');
            const name = item.getAttribute('data-name');
            if (name && name.includes(searchTerm)) {
                item.classList.remove('hidden');
                // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã
                let parent = item.closest('.category-node:not(.child-node)');
                while (parent) {
                    parent.classList.remove('hidden');
                    const children = parent.querySelector('.node-children');
                    if (children) {
                        children.style.display = 'block';
                        const toggle = parent.querySelector('.toggle-icon');
                        if (toggle) toggle.textContent = '‚ûñ';
                    }
                    parent = parent.parentElement?.closest('.category-node:not(.child-node)');
                }
            }
        });
    });

    // –†–∞—Å–∫—Ä—ã—Ç–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    function toggleCategory(toggleElement) {
        const node = toggleElement.closest('.category-node');
        const childrenContainer = node.querySelector('.node-children');
        if (childrenContainer) {
            if (childrenContainer.style.display === 'none' || !childrenContainer.style.display) {
                childrenContainer.style.display = 'block';
                toggleElement.textContent = '‚ûñ';
            } else {
                childrenContainer.style.display = 'none';
                toggleElement.textContent = '‚ûï';
            }
        }
    }

    // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–∞—Å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
    function confirmDanger(message) {
        return confirm(`‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: ${message}\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!`);
    }

    // –¢–µ—Å—Ç API –ª–æ–∫–∞—Ü–∏–π
    function testLocationsAPI() {
        fetch('/api/locations?search=–º–æ—Å–∫')
            .then(response => response.json())
            .then(data => {
                alert(`–ù–∞–π–¥–µ–Ω–æ ${data.length} –ª–æ–∫–∞—Ü–∏–π. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.`);
                console.log('–¢–µ—Å—Ç API –ª–æ–∫–∞—Ü–∏–π:', data);
            })
            .catch(error => {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ API: ' + error.message);
                console.error('–û—à–∏–±–∫–∞ API:', error);
            });
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å —à–∞–±–ª–æ–Ω
    function showTemplate() {
        const modal = new bootstrap.Modal(document.getElementById('templateModal'));
        modal.show();
    }

    // –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω
    function copyTemplate() {
        const template = document.getElementById('csvTemplate').textContent;
        navigator.clipboard.writeText(template).then(() => {
            alert('–®–∞–±–ª–æ–Ω —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
        });
    }

    // –°–∫–∞—á–∞—Ç—å —à–∞–±–ª–æ–Ω
    document.getElementById('downloadTemplate')?.addEventListener('click', function (e) {
        e.preventDefault();
        const template = document.getElementById('csvTemplate').textContent;
        const blob = new Blob([template], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = '—à–∞–±–ª–æ–Ω_—Ä–µ–≥–∏–æ–Ω–æ–≤.csv';
        link.click();
    });

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –≤—Å–µ—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    function clearAllCategoryImages() {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –í–°–ï –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
            fetch('{{ url_for("admin_bp.admin_categories") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'csrf_token': '{{ csrf_token() }}',
                    'action': 'clear_images'
                })
            }).then(response => {
                if (response.redirected) {
                    window.location.href = response.url;
                }
            });
        }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    document.getElementById('categoryImageInput')?.addEventListener('change', function () {
        const textSpan = document.getElementById('categoryImageText');
        const previewDiv = document.getElementById('categoryImagePreview');
        const previewImg = document.getElementById('categoryPreviewImg');
        const removeCheckbox = document.getElementById('removeImageCheckbox');

        if (this.files.length > 0) {
            const file = this.files[0];
            textSpan.textContent = file.name;
            textSpan.style.color = 'var(--avito-blue)';

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ (5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 5MB');
                this.value = '';
                textSpan.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...';
                textSpan.style.color = '';
                return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
            const reader = new FileReader();
            reader.onload = function (e) {
                previewImg.src = e.target.result;
                previewDiv.style.display = 'block';
                if (removeCheckbox) {
                    removeCheckbox.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º —á–µ–∫–±–æ–∫—Å —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞
                }
            }
            reader.readAsDataURL(file);
        } else {
            textSpan.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...';
            textSpan.style.color = 'var(--text-secondary)';
        }
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', function () {
        // –°–∫—Ä—ã—Ç—å –≤—ã–±–æ—Ä —Ä–µ–≥–∏–æ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (—Ç–∏–ø - —Ä–µ–≥–∏–æ–Ω)
        changeLocationType('region');

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Ñ–∞–π–ª–æ–≤—ã—Ö –∏–Ω–ø—É—Ç–æ–≤
        const fileInputs = document.querySelectorAll('input[type="file"]');
        fileInputs.forEach(input => {
            input.addEventListener('change', function () {
                const label = this.nextElementSibling;
                const textSpan = label.querySelector('.file-input-text');
                if (this.files.length > 0) {
                    textSpan.textContent = this.files[0].name;
                    textSpan.style.color = 'var(--avito-blue)';
                } else {
                    textSpan.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª...';
                    textSpan.style.color = 'var(--text-secondary)';
                }
            });
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –∞—Ç—Ä–∏–±—É—Ç data-id –¥–ª—è –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ ID
        document.querySelectorAll('.category-node').forEach((node, index) => {
            if (!node.hasAttribute('data-id')) {
                node.setAttribute('data-id', index);
            }
        });
    });
</script>

<style>
    /* Fix to ensure modal is above everything */
    .image-modal {
        z-index: 1060 !important;
    }

    .modal-backdrop {
        z-index: 1050 !important;
    }

    /* Ensure the close button is visible */
    .btn-close-white {
        filter: invert(1) grayscale(100%) brightness(200%);
    }
</style>
{% endblock %}