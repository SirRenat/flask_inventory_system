{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="admin-header">
        <h1 class="page-title">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å</h1>
        <p class="admin-subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–æ–π –∏ –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º</p>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∏ ‚Äî –ù–ê–°–¢–û–Ø–©–ò–ï –°–°–´–õ–ö–ò -->
    <div class="admin-tabs mb-4">
        <div class="tabs">
            <a href="{{ url_for('main.admin_categories') }}" class="tab-btn active">üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏</a>
            <a href="{{ url_for('main.admin_users') }}" class="tab-btn">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
            <a href="#" class="tab-btn">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="stats-cards">
        <div class="stat-card">
            <div class="stat-icon">üìÅ</div>
            <div class="stat-number">{{ categories|length }}</div>
            <div class="stat-label">–í—Å–µ–≥–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üìÇ</div>
            <div class="stat-number">{{ parent_categories|length }}</div>
            <div class="stat-label">–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏—Ö</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üåç</div>
            <div class="stat-number">{{ all_regions|length if all_regions else 0 }}</div>
            <div class="stat-label">–†–µ–≥–∏–æ–Ω–æ–≤</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üèôÔ∏è</div>
            <div class="stat-number">{{ cities_count if cities_count else 0 }}</div>
            <div class="stat-label">–ì–æ—Ä–æ–¥–æ–≤</div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç –≤ 2 –∫–æ–ª–æ–Ω–∫–∏ -->
    <div class="layout-container">
        <!-- –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê -->
        <div class="content-container">
            <!-- –ë–õ–û–ö: –ö–ê–¢–ï–ì–û–†–ò–ò -->
            <div class="category-block admin-section-block">
                <div class="block-header">
                    <div class="block-title">
                        <span class="block-icon">üìÇ</span>
                        <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤</h3>
                    </div>
                    <span class="block-badge">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</span>
                </div>

                <!-- –ü–æ–∏—Å–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π -->
                <div class="admin-section compact-section">
                    <div class="section-header">
                        <h4>üîç –ü–æ–∏—Å–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π</h4>
                        <span class="section-badge">–§–∏–ª—å—Ç—Ä</span>
                    </div>
                    <div class="section-card compact-card">
                        <div class="form-group">
                            <input type="text" 
                                   id="categorySearch" 
                                   class="form-control form-control-sm" 
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏...">
                            <small class="form-text">–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞</small>
                        </div>
                    </div>
                </div>

                <!-- –î–µ—Ä–µ–≤–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π -->
                <div class="admin-section">
                    <div class="section-header">
                        <h4>üå≥ –î–µ—Ä–µ–≤–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π</h4>
                        <span class="section-badge">–ü—Ä–æ—Å–º–æ—Ç—Ä</span>
                    </div>
                    <div class="section-card">
                        {% if categories %}
                            <div class="categories-tree" id="categoriesTree">
                                {% for parent in parent_categories %}
                                <div class="category-node" data-name="{{ parent.name|lower }}">
                                    <div class="node-header">
                                        {% set children = categories|selectattr('parent_id', 'equalto', parent.id)|list %}
                                        {% if children %}
                                            <span class="toggle-icon" onclick="toggleCategory(this)">‚ûï</span>
                                        {% else %}
                                            <span class="toggle-icon">‚îú‚îÄ</span>
                                        {% endif %}
                                        <span class="node-icon">üìÅ</span>
                                        <span class="node-name">{{ parent.name }}</span>
                                        {% if parent.description %}
                                        <span class="node-description text-muted">({{ parent.description }})</span>
                                        {% endif %}
                                        <span class="node-badge">{{ parent.products|length if parent.products else 0 }} —Ç–æ–≤.</span>
                                        <div class="node-actions">
                                            <button class="node-action-btn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
                                                    onclick="editCategory({{ parent.id }}, '{{ parent.name }}', '{{ parent.description or '' }}', {{ parent.parent_id or 'null' }})">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M11 4H4v7h7V4z"></path>
                                                    <path d="M17.7 4L15.9 5.8 12.3 2.2 10.5 4l3.6 3.6 1.8-1.8 3.6 3.6 1.8-1.8L17.7 4z"></path>
                                                </svg>
                                            </button>
                                            
                                            <form method="POST" action="{{ url_for('main.admin_categories') }}" 
                                                  onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏ –≤—Å–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏?')" class="inline-form">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                <input type="hidden" name="action" value="delete_category">
                                                <input type="hidden" name="category_id" value="{{ parent.id }}">
                                                <button type="submit" class="node-action-btn" title="–£–¥–∞–ª–∏—Ç—å">
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M3 6h18v2H3V6z"></path>
                                                        <path d="M8 6V4c0-1.1.9-2 2-2h4c1.1 0 2 .9 2 2v2M12 10v6m0 0l-2-2m2 2l2-2"></path>
                                                    </svg>
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                    
                                    {% if children %}
                                    <div class="node-children" style="display: none;">
                                        {% for child in children %}
                                        <div class="category-node child-node" data-name="{{ child.name|lower }}">
                                            <div class="node-header">
                                                <span class="toggle-icon">‚îî‚îÄ</span>
                                                <span class="node-icon">üìÑ</span>
                                                <span class="node-name">{{ child.name }}</span>
                                                {% if child.description %}
                                                <span class="node-description text-muted">({{ child.description }})</span>
                                                {% endif %}
                                                <span class="node-badge">{{ child.products|length if child.products else 0 }} —Ç–æ–≤.</span>
                                                <div class="node-actions">
                                                    <button class="node-action-btn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
                                                            onclick="editCategory({{ child.id }}, '{{ child.name }}', '{{ child.description or '' }}', {{ child.parent_id or 'null' }})">
                                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <path d="M11 4H4v7h7V4z"></path>
                                                            <path d="M17.7 4L15.9 5.8 12.3 2.2 10.5 4l3.6 3.6 1.8-1.8 3.6 3.6 1.8-1.8L17.7 4z"></path>
                                                        </svg>
                                                    </button>
                                                    
                                                    <form method="POST" action="{{ url_for('main.admin_categories') }}" 
                                                          onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é?')" class="inline-form">
                                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                        <input type="hidden" name="action" value="delete_category">
                                                        <input type="hidden" name="category_id" value="{{ child.id }}">
                                                        <button type="submit" class="node-action-btn" title="–£–¥–∞–ª–∏—Ç—å">
                                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                                <path d="M3 6h18v2H3V6z"></path>
                                                                <path d="M8 6V4c0-1.1.9-2 2-2h4c1.1 0 2 .9 2 2v2M12 10v6m0 0l-2-2m2 2l2-2"></path>
                                                            </svg>
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="empty-state">
                                <div class="empty-icon">üì≠</div>
                                <p>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é -->
                <div class="admin-section compact-section">
                    <div class="section-header">
                        <h4>‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h4>
                        <span class="section-badge">–†—É—á–Ω–æ–µ</span>
                    </div>
                    <div class="section-card compact-card">
                        <form method="POST" action="{{ url_for('main.admin_categories') }}" class="category-form" id="addCategoryForm">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="action" value="add_category">
                            <input type="hidden" name="category_id" id="editCategoryId" value="">
                            <div class="form-row">
                                <div class="form-group">
                                    <input type="text" name="name" id="categoryName" class="form-control form-control-sm" required placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ *">
                                </div>
                                <div class="form-group">
                                    <select name="parent_id" id="categoryParent" class="form-select form-select-sm">
                                        <option value="">-- –ë–µ–∑ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π --</option>
                                        {% for cat in categories %}
                                            <option value="{{ cat.id }}">{{ cat.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <textarea name="description" id="categoryDescription" class="form-control form-control-sm" rows="2" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>
                            </div>
                            <div class="form-actions compact-actions">
                                <button type="submit" class="btn-primary btn-sm" id="categorySubmitBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
                                <button type="reset" class="btn-secondary btn-sm" onclick="resetCategoryForm()">–û—á–∏—Å—Ç–∏—Ç—å</button>
                                <button type="button" class="btn-warning btn-sm" id="categoryCancelBtn" style="display: none;" onclick="resetCategoryForm()">–û—Ç–º–µ–Ω–∞</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π -->
                <div class="admin-section compact-section">
                    <div class="section-header">
                        <h4>üìÅ –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π</h4>
                        <span class="section-badge">–ò–º–ø–æ—Ä—Ç</span>
                    </div>
                    <div class="section-card compact-card">
                        <form method="POST" action="{{ url_for('main.upload_categories') }}" enctype="multipart/form-data" class="upload-form">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <div class="file-input-wrapper">
                                <input type="file" name="categories_file" accept=".json" class="form-control form-control-sm" required id="jsonFile">
                                <label for="jsonFile" class="file-input-label">
                                    <span class="file-input-text">–í—ã–±–µ—Ä–∏—Ç–µ JSON —Ñ–∞–π–ª...</span>
                                    <span class="btn-secondary btn-sm">üìÅ</span>
                                </label>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç: JSON —Å –∏–µ—Ä–∞—Ä—Ö–∏–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–π</small>
                            </div>
                            <button type="submit" class="btn-primary btn-sm mt-2">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- –ë–õ–û–ö: –†–ï–ì–ò–û–ù–´ –ò –ì–û–†–û–î–ê -->
            <div class="locations-block admin-section-block">
                <div class="block-header">
                    <div class="block-title">
                        <span class="block-icon">üåç</span>
                        <h3>–†–µ–≥–∏–æ–Ω—ã –∏ –≥–æ—Ä–æ–¥–∞</h3>
                    </div>
                    <span class="block-badge">–ì–µ–æ–≥—Ä–∞—Ñ–∏—è</span>
                </div>

                <!-- –î–µ—Ä–µ–≤–æ —Ä–µ–≥–∏–æ–Ω–æ–≤ -->
                <div class="admin-section">
                    <div class="section-header">
                        <h4>üìç –î–µ—Ä–µ–≤–æ —Ä–µ–≥–∏–æ–Ω–æ–≤ –∏ –≥–æ—Ä–æ–¥–æ–≤</h4>
                        <span class="section-badge">–ü—Ä–æ—Å–º–æ—Ç—Ä</span>
                    </div>
                    <div class="section-card">
                        {% if regions and regions|length > 0 %}
                            <div class="categories-tree" id="regionsTree">
                                {% for region in regions %}
                                <div class="category-node" data-name="{{ region.name|lower }}">
                                    <div class="node-header">
                                        {% set region_cities = [] %}
                                        {% for city in cities %}
                                            {% if city.region_id == region.id %}
                                                {% set _ = region_cities.append(city) %}
                                            {% endif %}
                                        {% endfor %}
                                        {% if region_cities %}
                                            <span class="toggle-icon" onclick="toggleCategory(this)">‚ûï</span>
                                        {% else %}
                                            <span class="toggle-icon">‚îú‚îÄ</span>
                                        {% endif %}
                                        <span class="node-icon">üìç</span>
                                        <span class="node-name">{{ region.name }}</span>
                                        <span class="node-badge">{{ region_cities|length }} –≥–æ—Ä.</span>
                                        <div class="node-actions">
                                            <button class="node-action-btn" title="–î–æ–±–∞–≤–∏—Ç—å –≥–æ—Ä–æ–¥" onclick="showAddCityForm({{ region.id }}, '{{ region.name }}')">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M12 5v14m-7-7h14"></path>
                                                </svg>
                                            </button>
                                            <form method="POST" action="{{ url_for('main.delete_region', region_id=region.id) }}" 
                                                onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —Ä–µ–≥–∏–æ–Ω –∏ –≤—Å–µ –≥–æ—Ä–æ–¥–∞?')">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                <button type="submit" class="node-action-btn" title="–£–¥–∞–ª–∏—Ç—å">
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M3 6h18v2H3V6z"></path>
                                                        <path d="M8 6V4c0-1.1.9-2 2-2h4c1.1 0 2 .9 2 2v2M12 10v6m0 0l-2-2m2 2l2-2"></path>
                                                    </svg>
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                    
                                    {% if region_cities %}
                                    <div class="node-children" style="display: none;">
                                        {% for city in region_cities %}
                                        <div class="category-node child-node" data-name="{{ city.name|lower }}">
                                            <div class="node-header">
                                                <span class="toggle-icon">‚îî‚îÄ</span>
                                                <span class="node-icon">üèôÔ∏è</span>
                                                <span class="node-name">{{ city.name }}</span>
                                                <div class="node-actions">
                                                    <form method="POST" action="{{ url_for('main.delete_city', city_id=city.id) }}" 
                                                        onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –≥–æ—Ä–æ–¥?')">
                                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                        <button type="submit" class="node-action-btn" title="–£–¥–∞–ª–∏—Ç—å">
                                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                                <path d="M3 6h18v2H3V6z"></path>
                                                                <path d="M8 6V4c0-1.1.9-2 2-2h4c1.1 0 2 .9 2 2v2M12 10v6m0 0l-2-2m2 2l2-2"></path>
                                                            </svg>
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="empty-state">
                                <div class="empty-icon">üåç</div>
                                <p>–†–µ–≥–∏–æ–Ω—ã –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</p>
                                <small style="color: #666;">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º—É –Ω–∏–∂–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è</small>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–≥–∏–æ–Ω/–≥–æ—Ä–æ–¥ -->
                <div class="admin-section compact-section">
                    <div class="section-header">
                        <h4>‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–≥–∏–æ–Ω/–≥–æ—Ä–æ–¥</h4>
                        <span class="section-badge">–†—É—á–Ω–æ–µ</span>
                    </div>
                    <div class="section-card compact-card">
                        <form method="POST" action="{{ url_for('main.add_region') }}" class="category-form" id="addLocationForm">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="location_type" id="locationType" value="region">
                            
                            <div class="form-group mb-2">
                                <select name="location_type_select" id="locationTypeSelect" class="form-select form-select-sm" onchange="changeLocationType(this.value)">
                                    <option value="region">–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–≥–∏–æ–Ω</option>
                                    <option value="city">–î–æ–±–∞–≤–∏—Ç—å –≥–æ—Ä–æ–¥</option>
                                </select>
                            </div>
                            
                            <div class="form-group mb-2" id="regionSelectGroup">
                                <select name="parent_id" id="parentRegionSelect" class="form-select form-select-sm">
                                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω --</option>
                                    {% for region in regions %}
                                        <option value="{{ region.id }}">{{ region.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="form-group mb-2">
                                <input type="text" name="name" id="locationName" class="form-control form-control-sm" required placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ *">
                            </div>
                            
                            <div class="form-group mb-2">
                                <textarea name="description" id="locationDescription" class="form-control form-control-sm" rows="2" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
                            </div>
                            
                            <div class="form-actions compact-actions">
                                <button type="submit" class="btn-primary btn-sm" id="locationSubmitBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–≥–∏–æ–Ω</button>
                                <button type="reset" class="btn-secondary btn-sm">–û—á–∏—Å—Ç–∏—Ç—å</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–≥–∏–æ–Ω–æ–≤ –∏ –≥–æ—Ä–æ–¥–æ–≤ -->
                <div class="admin-section compact-section">
                    <div class="section-header">
                        <h4>üì• –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–≥–∏–æ–Ω–æ–≤ –∏ –≥–æ—Ä–æ–¥–æ–≤</h4>
                        <span class="section-badge">–ú–∞—Å—Å–æ–≤—ã–π –∏–º–ø–æ—Ä—Ç</span>
                    </div>
                    <div class="section-card compact-card">
                        <form method="POST" action="{{ url_for('main.upload_locations') }}" enctype="multipart/form-data" class="upload-form">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            
                            <div class="mb-2">
                                <label class="form-label">–§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞:</label>
                                <select name="file_type" class="form-select form-select-sm" required>
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç...</option>
                                    <option value="csv">CSV (—Ä–µ–≥–∏–æ–Ω—ã –∏ –≥–æ—Ä–æ–¥–∞)</option>
                                    <option value="json">JSON (—Ä–µ–≥–∏–æ–Ω—ã –∏ –≥–æ—Ä–æ–¥–∞)</option>
                                </select>
                            </div>
                            
                            <div class="file-input-wrapper mb-2">
                                <input type="file" name="locations_file" accept=".csv,.json,.txt" class="form-control form-control-sm" required id="locationsFile">
                                <label for="locationsFile" class="file-input-label">
                                    <span class="file-input-text">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª...</span>
                                    <span class="btn-secondary btn-sm">üìÅ</span>
                                </label>
                            </div>
                            
                            <div class="mb-3">
                                <small class="text-muted d-block">–§–æ—Ä–º–∞—Ç CSV: <code>—Ä–µ–≥–∏–æ–Ω;–≥–æ—Ä–æ–¥</code> –∏–ª–∏ <code>—Ä–µ–≥–∏–æ–Ω,–≥–æ—Ä–æ–¥</code></small>
                               <small class="text-muted d-block">–§–æ—Ä–º–∞—Ç JSON: 
                                    <code>{"regions": [{"name": "–†–µ–≥–∏–æ–Ω", "cities": ["–ì–æ—Ä–æ–¥1", "–ì–æ—Ä–æ–¥2"]}]}</code>
                                    –∏–ª–∏ 
                                    <code>[{"region": "–†–µ–≥–∏–æ–Ω", "city": "–ì–æ—Ä–æ–¥"}]</code>
                                </small>
                            </div>
                            
                            <div class="form-check mb-3">
                                <input type="checkbox" name="clear_existing" id="clearExisting" class="form-check-input">
                                <label for="clearExisting" class="form-check-label">–£–¥–∞–ª–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ</label>
                            </div>
                            
                            <button type="submit" class="btn-primary btn-sm">üåç –ó–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–∫–∞—Ü–∏–∏</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê (sidebar) -->
        <div class="sidebar-container">
            <div class="sidebar">
                <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
                <div class="sidebar-section">
                    <h4 class="sidebar-title">‚ö° –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h4>
                    <div class="quick-actions">
                        <button class="quick-action" onclick="testLocationsAPI()">
                            <span class="action-icon">üîç</span>
                            <span class="action-text">–¢–µ—Å—Ç API –ª–æ–∫–∞—Ü–∏–π</span>
                        </button>
                        <button class="quick-action" onclick="showTemplate()">
                            <span class="action-icon">üìã</span>
                            <span class="action-text">–®–∞–±–ª–æ–Ω CSV</span>
                        </button>
                        <a href="{{ url_for('main.test_populate_locations') }}" class="quick-action">
                            <span class="action-icon">üß™</span>
                            <span class="action-text">–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ</span>
                        </a>
                    </div>
                </div>

                <!-- –û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞ -->
                <div class="sidebar-section danger-zone">
                    <h4 class="sidebar-title">‚ö†Ô∏è –û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞</h4>
                    <div class="danger-actions">
                        <form method="POST" action="{{ url_for('main.clear_categories') }}" 
                              onsubmit="return confirmDanger('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã!')">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn-danger btn-full">
                                <span class="btn-icon">üóëÔ∏è</span>
                                –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                            </button>
                        </form>
                        
                        <form method="POST" action="{{ url_for('main.admin_categories') }}" 
                              onsubmit="return confirmDanger('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –ø—É—Å—Ç—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –±–µ–∑ —Ç–æ–≤–∞—Ä–æ–≤?')">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="action" value="clear_empty">
                            <button type="submit" class="btn-warning btn-full">
                                <span class="btn-icon">üßπ</span>
                                –û—á–∏—Å—Ç–∏—Ç—å –ø—É—Å—Ç—ã–µ
                            </button>
                        </form>

                    </div>
                </div>

                <!-- –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã -->
                <div class="sidebar-section">
                    <h4 class="sidebar-title">üìà –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</h4>
                    <div class="system-status">
                        <div class="status-item">
                            <span class="status-label">–ö–∞—Ç–µ–≥–æ—Ä–∏–π:</span>
                            <span class="status-value">{{ categories|length }}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">–†–µ–≥–∏–æ–Ω–æ–≤:</span>
                            <span class="status-value">{{ all_regions|length if all_regions else 0 }}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">–ì–æ—Ä–æ–¥–æ–≤:</span>
                            <span class="status-value">{{ cities_count if cities_count else 0 }}</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">–¢–æ–≤–∞—Ä–æ–≤:</span>
                            <span class="status-value">{{ total_products or 0 }}</span>
                        </div>
                    </div>
                </div>

                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–æ—Ä–º–∞—Ç–∞—Ö -->
                <div class="sidebar-section">
                    <h4 class="sidebar-title">‚ÑπÔ∏è –§–æ—Ä–º–∞—Ç—ã —Ñ–∞–π–ª–æ–≤</h4>
                    <div class="format-info">
                        <div class="format-item">
                            <strong>CSV:</strong> –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å ; –∏–ª–∏ ,
                        </div>
                        <div class="format-item">
                            <strong>–ö–æ–¥–∏—Ä–æ–≤–∫–∞:</strong> UTF-8
                        </div>
                        <div class="format-item">
                            <strong>–ü—Ä–∏–º–µ—Ä:</strong><br>
                            <code>–ú–æ—Å–∫–≤–∞;–ú–æ—Å–∫–≤–∞</code><br>
                            <code>–ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å;–•–∏–º–∫–∏</code>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —à–∞–±–ª–æ–Ω–∞ -->
<div class="modal fade" id="templateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–®–∞–±–ª–æ–Ω CSV —Ñ–∞–π–ª–∞</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre id="csvTemplate">—Ä–µ–≥–∏–æ–Ω;–≥–æ—Ä–æ–¥
–ú–æ—Å–∫–≤–∞;–ú–æ—Å–∫–≤–∞
–ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å;–•–∏–º–∫–∏
–ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å;–ü–æ–¥–æ–ª—å—Å–∫
–ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å;–ö–æ—Ä–æ–ª—ë–≤
–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥;–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥
–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å;–ì–∞—Ç—á–∏–Ω–∞
–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å;–í—ã–±–æ—Ä–≥
–†–µ—Å–ø—É–±–ª–∏–∫–∞ –¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω;–ö–∞–∑–∞–Ω—å
–†–µ—Å–ø—É–±–ª–∏–∫–∞ –¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω;–ù–∞–±–µ—Ä–µ–∂–Ω—ã–µ –ß–µ–ª–Ω—ã
–†–µ—Å–ø—É–±–ª–∏–∫–∞ –¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω;–ê–ª—å–º–µ—Ç—å–µ–≤—Å–∫
–°–≤–µ—Ä–¥–ª–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å;–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥
–°–≤–µ—Ä–¥–ª–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å;–ù–∏–∂–Ω–∏–π –¢–∞–≥–∏–ª
–°–≤–µ—Ä–¥–ª–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å;–ö–∞–º–µ–Ω—Å–∫-–£—Ä–∞–ª—å—Å–∫–∏–π</pre>
                <div class="mt-3">
                    <button class="btn btn-sm btn-secondary" onclick="copyTemplate()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                    <a href="#" class="btn btn-sm btn-primary" id="downloadTemplate">–°–∫–∞—á–∞—Ç—å CSV</a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –±–ª–æ–∫–æ–≤ */
.admin-section-block {
    background: var(--background);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border);
    margin-bottom: 24px;
    overflow: hidden;
    box-shadow: var(--shadow);
}

.category-block {
    border-top: 4px solid #3498db;
}

.locations-block {
    border-top: 4px solid #2ecc71;
}

.block-header {
    background: var(--background-secondary);
    padding: 16px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border);
}

.block-title {
    display: flex;
    align-items: center;
    gap: 12px;
}

.block-icon {
    font-size: 24px;
}

.block-title h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
}

.block-badge {
    background: var(--avito-blue);
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
}

.locations-block .block-badge {
    background: #2ecc71;
}

/* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ä–º */
.compact-section { margin-bottom: 16px; }
.compact-card { padding: 16px; }

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border);
}

.section-header h4 {
    margin: 0;
    font-size: 15px;
    font-weight: 600;
    color: var(--text-primary);
}

.section-badge {
    background: var(--background);
    color: var(--text-secondary);
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 500;
    border: 1px solid var(--border);
}

.section-card {
    background: var(--background-secondary);
    border-radius: var(--radius);
    padding: 20px;
    border: 1px solid var(--border);
}

/* –°—Ç–∏–ª–∏ –¥–µ—Ä–µ–≤–∞ */
/* –°—Ç–∏–ª–∏ –¥–µ—Ä–µ–≤–∞ - –ö–û–ú–ü–ê–ö–¢–ù–´–ï */
.categories-tree {
    background: var(--background-secondary);
    border-radius: var(--radius);
    padding: 8px;
    max-height: 350px;
    overflow-y: auto;
    border: 1px solid var(--border);
    font-size: 13px;
}

.category-node { 
    margin-bottom: 2px; 
    padding-left: 4px;
    line-height: 1.3;
}

.category-node.child-node { 
    padding-left: 20px;
    margin-top: 1px;
}

.node-header {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 8px;
    font-size: 13px;
    border-radius: 4px;
    min-height: 28px;
    transition: background 0.2s;
}

.node-header:hover { 
    background: rgba(0, 0, 0, 0.04);
}

.toggle-icon {
    font-size: 10px;
    cursor: pointer;
    min-width: 16px;
    text-align: center;
    color: var(--text-tertiary);
    user-select: none;
}

.node-icon { 
    font-size: 12px; 
    opacity: 0.8; 
    min-width: 16px;
    text-align: center;
}

.node-name { 
    color: var(--text-primary); 
    font-weight: 500; 
    flex: 1;
    font-size: 13px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.node-description { 
    font-size: 11px; 
    color: var(--text-tertiary); 
    margin-left: 6px;
    font-style: italic;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 150px;
}

.node-badge {
    background: var(--avito-blue-light);
    color: var(--avito-blue);
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 600;
    min-width: 40px;
    text-align: center;
}

.node-actions { 
    display: flex; 
    gap: 2px; 
    opacity: 0.7;
    margin-left: auto;
}

.node-header:hover .node-actions { 
    opacity: 1; 
}

.node-action-btn {
    background: transparent;
    border: 1px solid var(--border);
    padding: 3px 6px;
    border-radius: 3px;
    color: var(--text-secondary);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    min-width: 24px;
    min-height: 24px;
}

.node-action-btn:hover {
    background: var(--avito-blue-light);
    color: var(--avito-blue);
    border-color: var(--avito-blue);
    transform: scale(1.05);
}

.node-action-btn svg { 
    width: 12px; 
    height: 12px; 
}

.node-children { 
    padding-left: 20px; 
    margin-top: 2px;
    margin-bottom: 2px;
    border-left: 1px dashed var(--border);
    margin-left: 8px;
}

/* –£–º–µ–Ω—å—à–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã —É –±–ª–æ–∫–æ–≤ —Å –¥–µ—Ä–µ–≤—å—è–º–∏ */
.admin-section .section-card {
    padding: 12px;
}

/* –§–æ—Ä–º—ã */
.form-control-sm, .form-select-sm {
    padding: 8px 12px;
    font-size: 14px;
    border-radius: var(--radius);
}
.btn-sm {
    padding: 8px 16px;
    font-size: 14px;
    border-radius: var(--radius);
}
.compact-actions { 
    display: flex; 
    gap: 8px; 
    margin-top: 12px;
}
.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 12px;
}
@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
    }
}

/* –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ */
.file-input-wrapper {
    position: relative;
    margin-bottom: 12px;
}
.file-input-wrapper input[type="file"] {
    position: absolute;
    width: 1px;
    height: 1px;
    opacity: 0;
}
.file-input-label {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    background: var(--background);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
}
.file-input-label:hover {
    border-color: var(--avito-blue);
    background: var(--avito-blue-light);
}
.file-input-text {
    color: var(--text-secondary);
}
.file-input-label:hover .file-input-text {
    color: var(--avito-blue);
}

/* Sidebar –∏ layout */
.sidebar-container { 
    width: 300px; 
    flex-shrink: 0; 
}
.sidebar {
    background: var(--background);
    border-radius: var(--radius-lg);
    padding: 20px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
    height: fit-content;
    position: sticky;
    top: 20px;
}
.sidebar-title {
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 12px;
    color: var(--text-primary);
}
.sidebar-section {
    margin-bottom: 24px;
    padding-bottom: 24px;
    border-bottom: 1px solid var(--border);
}
.sidebar-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}

.quick-actions { display: flex; flex-direction: column; gap: 8px; }
.quick-action {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 12px;
    background: var(--background-secondary);
    border-radius: var(--radius);
    text-decoration: none;
    color: var(--text-primary);
    border: none;
    width: 100%;
    text-align: left;
    cursor: pointer;
    transition: all 0.2s;
}
.quick-action:hover {
    background: var(--avito-blue-light);
    color: var(--avito-blue);
    transform: translateX(4px);
}

.danger-zone {
    border-left: 3px solid #f5576c;
    padding-left: 12px;
}
.danger-actions { display: flex; flex-direction: column; gap: 10px; }
.btn-danger, .btn-warning {
    padding: 10px;
    font-size: 14px;
    text-align: center;
    border-radius: var(--radius);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.2s;
}
.btn-danger { background: #f5576c; color: white; }
.btn-danger:hover { background: #e74c3c; }
.btn-warning { background: #f39c12; color: white; }
.btn-warning:hover { background: #e67e22; }
.btn-full { width: 100%; }

.layout-container {
    display: flex;
    gap: 24px;
    align-items: flex-start;
}
.content-container { 
    flex: 1; 
    min-width: 0; /* –î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ–±—Ä–µ–∑–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
}

/* –°—Ç–∞—Ç—É—Å –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */
.system-status, .format-info {
    display: flex;
    flex-direction: column;
    gap: 8px;
}
.status-item, .format-item {
    display: flex;
    justify-content: space-between;
    font-size: 13px;
}
.status-label, .format-item strong {
    color: var(--text-secondary);
}
.status-value {
    color: var(--text-primary);
    font-weight: 600;
}

/* –í–∫–ª–∞–¥–∫–∏ */
.admin-tabs { 
    background: var(--background); 
    border-radius: var(--radius); 
    border: 1px solid var(--border); 
    margin-bottom: 24px; 
    overflow: hidden; 
}
.tabs { 
    display: flex; 
    gap: 2px; 
    background: var(--background-secondary); 
    padding: 4px; 
}
.tab-btn {
    flex: 1;
    padding: 14px 20px;
    background: transparent;
    border: none;
    border-radius: calc(var(--radius) - 2px);
    font-weight: 500;
    color: var(--text-secondary);
    text-decoration: none;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    font-size: 14px;
}
.tab-btn:hover { background: var(--background); color: var(--text-primary); }
.tab-btn.active { background: var(--background); color: var(--avito-blue); box-shadow: var(--shadow-light); }

/* –ê–¥–º–∏–Ω-–∑–∞–≥–æ–ª–æ–≤–æ–∫ */
.admin-header {
    background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    color: white;
    padding: 32px;
    border-radius: 12px;
    margin-bottom: 24px;
    text-align: center;
}
.admin-header .page-title { font-size: 32px; margin-bottom: 8px; }

/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
.stats-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 16px;
    margin-bottom: 32px;
}
.stat-card {
    background: var(--background);
    padding: 20px;
    border-radius: var(--radius);
    text-align: center;
    border: 1px solid var(--border);
    box-shadow: var(--shadow-light);
    transition: transform 0.2s;
}
.stat-card:hover { transform: translateY(-2px); }
.stat-icon { font-size: 28px; margin-bottom: 10px; opacity: 0.8; }
.stat-number { font-size: 28px; font-weight: 700; color: var(--avito-blue); margin-bottom: 4px; }
.stat-label { color: var(--text-secondary); font-size: 13px; font-weight: 500; }

/* –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ */
.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-secondary);
}
.empty-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }

/* Responsive */
@media (max-width: 1024px) {
    .layout-container { flex-direction: column; }
    .sidebar-container { width: 100%; }
    .sidebar { position: static; }
}
@media (max-width: 768px) {
    .stats-cards { grid-template-columns: repeat(2, 1fr); }
    .tabs .tab-btn { font-size: 12px; padding: 10px 12px; }
    .admin-header { padding: 24px 16px; }
    .admin-header .page-title { font-size: 24px; }
}
@media (max-width: 480px) {
    .stats-cards { grid-template-columns: 1fr; }
}
</style>

<script>
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∏–ø–∞ –ª–æ–∫–∞—Ü–∏–∏
function changeLocationType(type) {
    const locationType = document.getElementById('locationType');
    const regionSelectGroup = document.getElementById('regionSelectGroup');
    const submitBtn = document.getElementById('locationSubmitBtn');
    
    locationType.value = type;
    
    if (type === 'city') {
        regionSelectGroup.style.display = 'block';
        submitBtn.textContent = '‚ûï –î–æ–±–∞–≤–∏—Ç—å –≥–æ—Ä–æ–¥';
        document.getElementById('parentRegionSelect').required = true;
    } else {
        regionSelectGroup.style.display = 'none';
        submitBtn.textContent = '‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–≥–∏–æ–Ω';
        document.getElementById('parentRegionSelect').required = false;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
function editCategory(id, name, description, parentId) {
    // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –∫–∞–≤—ã—á–∫–∏ –¥–ª—è JavaScript
    const safeName = name.replace(/'/g, "\\'");
    const safeDescription = (description || '').replace(/'/g, "\\'");
    
    document.getElementById('editCategoryId').value = id;
    document.getElementById('categoryName').value = name;
    document.getElementById('categoryDescription').value = description || '';
    document.getElementById('categoryParent').value = parentId || '';
    
    document.getElementById('categorySubmitBtn').textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
    document.getElementById('categoryCancelBtn').style.display = 'inline-block';
    
    // –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –∫ —Ñ–æ—Ä–º–µ
    document.getElementById('addCategoryForm').scrollIntoView({ behavior: 'smooth' });
}

// –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
function resetCategoryForm() {
    document.getElementById('editCategoryId').value = '';
    document.getElementById('categorySubmitBtn').textContent = '‚ûï –î–æ–±–∞–≤–∏—Ç—å';
    document.getElementById('categoryCancelBtn').style.display = 'none';
    document.getElementById('addCategoryForm').reset();
}

// –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≥–æ—Ä–æ–¥–∞
function showAddCityForm(regionId, regionName) {
    const locationTypeSelect = document.getElementById('locationTypeSelect');
    const parentRegionSelect = document.getElementById('parentRegionSelect');
    
    locationTypeSelect.value = 'city';
    parentRegionSelect.value = regionId;
    
    changeLocationType('city');
    
    // –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –∫ —Ñ–æ—Ä–º–µ
    document.getElementById('addLocationForm').scrollIntoView({ behavior: 'smooth' });
    
    // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
    alert(`–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ –≤ —Ä–µ–≥–∏–æ–Ω: ${regionName}`);
}

// –ü–æ–∏—Å–∫ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
document.getElementById('categorySearch')?.addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase().trim();
    const allItems = document.querySelectorAll('.category-node');
    
    if (!searchTerm) {
        allItems.forEach(item => item.classList.remove('hidden'));
        return;
    }
    
    allItems.forEach(item => {
        item.classList.add('hidden');
        const name = item.getAttribute('data-name');
        if (name && name.includes(searchTerm)) {
            item.classList.remove('hidden');
            // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã
            let parent = item.closest('.category-node:not(.child-node)');
            while (parent) {
                parent.classList.remove('hidden');
                const children = parent.querySelector('.node-children');
                if (children) {
                    children.style.display = 'block';
                    const toggle = parent.querySelector('.toggle-icon');
                    if (toggle) toggle.textContent = '‚ûñ';
                }
                parent = parent.parentElement?.closest('.category-node:not(.child-node)');
            }
        }
    });
});

// –†–∞—Å–∫—Ä—ã—Ç–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
function toggleCategory(toggleElement) {
    const node = toggleElement.closest('.category-node');
    const childrenContainer = node.querySelector('.node-children');
    if (childrenContainer) {
        if (childrenContainer.style.display === 'none' || !childrenContainer.style.display) {
            childrenContainer.style.display = 'block';
            toggleElement.textContent = '‚ûñ';
        } else {
            childrenContainer.style.display = 'none';
            toggleElement.textContent = '‚ûï';
        }
    }
}

// –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–∞—Å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
function confirmDanger(message) {
    return confirm(`‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: ${message}\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!`);
}

// –¢–µ—Å—Ç API –ª–æ–∫–∞—Ü–∏–π
function testLocationsAPI() {
    fetch('/api/locations?search=–º–æ—Å–∫')
        .then(response => response.json())
        .then(data => {
            alert(`–ù–∞–π–¥–µ–Ω–æ ${data.length} –ª–æ–∫–∞—Ü–∏–π. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.`);
            console.log('–¢–µ—Å—Ç API –ª–æ–∫–∞—Ü–∏–π:', data);
        })
        .catch(error => {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ API: ' + error.message);
            console.error('–û—à–∏–±–∫–∞ API:', error);
        });
}

// –ü–æ–∫–∞–∑–∞—Ç—å —à–∞–±–ª–æ–Ω
function showTemplate() {
    const modal = new bootstrap.Modal(document.getElementById('templateModal'));
    modal.show();
}

// –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω
function copyTemplate() {
    const template = document.getElementById('csvTemplate').textContent;
    navigator.clipboard.writeText(template).then(() => {
        alert('–®–∞–±–ª–æ–Ω —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
    });
}

// –°–∫–∞—á–∞—Ç—å —à–∞–±–ª–æ–Ω
document.getElementById('downloadTemplate')?.addEventListener('click', function(e) {
    e.preventDefault();
    const template = document.getElementById('csvTemplate').textContent;
    const blob = new Blob([template], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = '—à–∞–±–ª–æ–Ω_—Ä–µ–≥–∏–æ–Ω–æ–≤.csv';
    link.click();
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
    // –°–∫—Ä—ã—Ç—å –≤—ã–±–æ—Ä —Ä–µ–≥–∏–æ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (—Ç–∏–ø - —Ä–µ–≥–∏–æ–Ω)
    changeLocationType('region');
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Ñ–∞–π–ª–æ–≤—ã—Ö –∏–Ω–ø—É—Ç–æ–≤
    const fileInputs = document.querySelectorAll('input[type="file"]');
    fileInputs.forEach(input => {
        input.addEventListener('change', function() {
            const label = this.nextElementSibling;
            const textSpan = label.querySelector('.file-input-text');
            if (this.files.length > 0) {
                textSpan.textContent = this.files[0].name;
                textSpan.style.color = 'var(--avito-blue)';
            } else {
                textSpan.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª...';
                textSpan.style.color = 'var(--text-secondary)';
            }
        });
    });
});
</script>
{% endblock %}